<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Entrega de Safra 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#5D5CDE',
                            '50': '#EEEEFF',
                            '100': '#D4D4F7',
                            '200': '#ACACEF',
                            '300': '#8584E7',
                            '400': '#5D5CDE',
                            '500': '#3635D5',
                            '600': '#2A29B0',
                            '700': '#211F8A',
                            '800': '#171664',
                            '900': '#0D0C3E'
                        },
                        secondary: {
                            DEFAULT: '#6B7280',
                            '50': '#F9FAFB',
                            '100': '#F3F4F6',
                            '200': '#E5E7EB',
                            '300': '#D1D5DB',
                            '400': '#9CA3AF',
                            '500': '#6B7280',
                            '600': '#4B5563',
                            '700': '#374151',
                            '800': '#1F2937',
                            '900': '#111827'
                        },
                        success: {
                            DEFAULT: '#10B981',
                            '50': '#ECFDF5',
                            '100': '#D1FAE5',
                            '200': '#A7F3D0',
                            '300': '#6EE7B7',
                            '400': '#34D399',
                            '500': '#10B981',
                            '600': '#059669',
                            '700': '#047857',
                            '800': '#065F46',
                            '900': '#064E3B'
                        },
                        warning: {
                            DEFAULT: '#F59E0B',
                            '50': '#FFFBEB',
                            '100': '#FEF3C7',
                            '200': '#FDE68A',
                            '300': '#FCD34D',
                            '400': '#FBBF24',
                            '500': '#F59E0B',
                            '600': '#D97706',
                            '700': '#B45309',
                            '800': '#92400E',
                            '900': '#78350F'
                        },
                        danger: {
                            DEFAULT: '#EF4444',
                            '50': '#FEF2F2',
                            '100': '#FEE2E2',
                            '200': '#FECACA',
                            '300': '#FCA5A5',
                            '400': '#F87171',
                            '500': '#EF4444',
                            '600': '#DC2626',
                            '700': '#B91C1C',
                            '800': '#991B1B',
                            '900': '#7F1D1D'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                    boxShadow: {
                        'inner-sm': 'inset 0 1px 2px 0 rgba(0, 0, 0, 0.05)',
                        'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'progress': 'progress 1s ease-in-out infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'bounce-sm': 'bounce-sm 1s infinite'
                    },
                    keyframes: {
                        progress: {
                            '0%': { width: '0%' },
                            '100%': { width: '100%' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        'bounce-sm': {
                            '0%, 100%': {
                                transform: 'translateY(-2px)',
                                animationTimingFunction: 'cubic-bezier(0.8, 0, 1, 1)'
                            },
                            '50%': {
                                transform: 'translateY(0)',
                                animationTimingFunction: 'cubic-bezier(0, 0, 0.2, 1)'
                            }
                        }
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        .input-number {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        .input-number::-webkit-outer-spin-button,
        .input-number::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Skeleton loading effect */
        .skeleton {
            animation: skeleton-loading 1.5s infinite;
            background-image: linear-gradient(90deg, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0));
            background-size: 200px 100%;
            background-repeat: no-repeat;
            background-position: -200px 0;
        }
        
        @keyframes skeleton-loading {
            100% { background-position: 200px 0; }
        }
        
        .dark .skeleton {
            animation: skeleton-loading-dark 1.5s infinite;
            background-image: linear-gradient(90deg, rgba(50, 50, 50, 0), rgba(50, 50, 50, 0.4), rgba(50, 50, 50, 0));
            background-size: 200px 100%;
            background-repeat: no-repeat;
            background-position: -200px 0;
        }
        
        @keyframes skeleton-loading-dark {
            100% { background-position: 200px 0; }
        }
        
        /* Transitions */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }
        .dark ::-webkit-scrollbar-track {
            background: #374151;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4B5563;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
        }
        
        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: auto;
            min-width: 120px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
        }
        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .dark .tooltip .tooltip-text {
            background-color: rgba(255, 255, 255, 0.8);
            color: #000;
        }
        .dark .tooltip .tooltip-text::after {
            border-color: rgba(255, 255, 255, 0.8) transparent transparent transparent;
        }

        /* Dashboard card hover effects */
        .dashboard-card {
            transition: all 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Calendar styles */
        .calendar-day {
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover:not(.disabled) {
            background-color: rgba(93, 92, 222, 0.1);
        }
        
        .calendar-day.selected {
            background-color: rgba(93, 92, 222, 0.2);
            font-weight: bold;
        }
        
        .calendar-day.current {
            border: 2px solid #5D5CDE;
        }
        
        .calendar-day.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        /* Accordion styles */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .accordion-open .accordion-content {
            max-height: 1000px;
        }
        
        /* Slideshow styles */
        .slide {
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        
        .slide.active {
            opacity: 1;
            transform: translateX(0);
        }
        
        .slide.inactive {
            opacity: 0;
            transform: translateX(100%);
            position: absolute;
        }
        
        /* Animation for achievements */
        @keyframes achievement-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .achievement-unlock {
            animation: achievement-pulse 0.5s ease-in-out;
        }
        
        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background-color: white !important;
                color: black !important;
            }
            
            .print-full-width {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            .print-break-after {
                page-break-after: always;
            }
        }
        
        /* Touch area increase for mobile */
        @media (max-width: 768px) {
            .touch-target {
                min-height: 44px;
                min-width: 44px;
            }
        }
        
        /* Dark mode transition */
        .dark-transition {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        /* Fancy focus rings */
        .focus-ring:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.5);
        }
        
        /* Custom checkbox */
        .custom-checkbox {
            position: relative;
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #6B7280;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .custom-checkbox.checked {
            background-color: #5D5CDE;
            border-color: #5D5CDE;
        }
        
        .custom-checkbox.checked::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        
        /* Weather icons */
        .weather-icon {
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.2));
        }
        
        .dark .weather-icon {
            filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.1));
        }
        
        /* Custom scrollbar for dropdown menus */
        .dropdown-scroll {
            max-height: 200px;
            overflow-y: auto;
            scrollbar-width: thin;
        }
        
        .dropdown-scroll::-webkit-scrollbar {
            width: 6px;
        }
        
        .dropdown-scroll::-webkit-scrollbar-thumb {
            background-color: #9CA3AF;
            border-radius: 3px;
        }
        
        .dark .dropdown-scroll::-webkit-scrollbar-thumb {
            background-color: #4B5563;
        }
        
        /* Grid background pattern */
        .grid-pattern {
            background-image: 
                linear-gradient(rgba(229, 231, 235, 0.5) 1px, transparent 1px),
                linear-gradient(90deg, rgba(229, 231, 235, 0.5) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .dark .grid-pattern {
            background-image: 
                linear-gradient(rgba(55, 65, 81, 0.5) 1px, transparent 1px),
                linear-gradient(90deg, rgba(55, 65, 81, 0.5) 1px, transparent 1px);
        }
        
        /* Glow effect for important elements */
        .glow {
            box-shadow: 0 0 15px rgba(93, 92, 222, 0.5);
        }
        
        .dark .glow {
            box-shadow: 0 0 15px rgba(93, 92, 222, 0.7);
        }
        
        /* Fancy number input */
        .fancy-number-input {
            position: relative;
        }
        
        .fancy-number-input button {
            position: absolute;
            right: 0;
            width: 20px;
            height: 50%;
            background-color: #E5E7EB;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .fancy-number-input button:hover {
            background-color: #D1D5DB;
        }
        
        .fancy-number-input button:first-of-type {
            top: 0;
            border-top-right-radius: 4px;
        }
        
        .fancy-number-input button:last-of-type {
            bottom: 0;
            border-bottom-right-radius: 4px;
        }
        
        .dark .fancy-number-input button {
            background-color: #374151;
        }
        
        .dark .fancy-number-input button:hover {
            background-color: #4B5563;
        }
        
        /* Text gradient for headings */
        .text-gradient {
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            background-image: linear-gradient(to right, #5D5CDE, #4F46E5);
        }
        
        .dark .text-gradient {
            background-image: linear-gradient(to right, #818CF8, #6366F1);
        }

        /* Empty state styles */
        .empty-state {
            border: 2px dashed #E5E7EB;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            color: #9CA3AF;
        }
        
        .dark .empty-state {
            border-color: #374151;
            color: #6B7280;
        }

        /* Help text style */
        .help-text {
            font-size: 0.875rem;
            color: #6B7280;
            margin-top: 0.5rem;
            font-style: italic;
        }
        
        .dark .help-text {
            color: #9CA3AF;
        }

        /* Placeholder text */
        .placeholder-text {
            color: #9CA3AF;
            font-style: italic;
        }
        
        .dark .placeholder-text {
            color: #6B7280;
        }
        
        /* History mode indicator */
        .history-mode-indicator {
            background-color: #FEF3C7;
            color: #92400E;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .dark .history-mode-indicator {
            background-color: #78350F;
            color: #FCD34D;
        }
        
        /* Date chip styles */
        .date-chip {
            display: inline-flex;
            align-items: center;
            background-color: #E5E7EB;
            color: #374151;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .date-chip:hover {
            background-color: #D1D5DB;
        }
        
        .date-chip.selected {
            background-color: #5D5CDE;
            color: white;
        }
        
        .dark .date-chip {
            background-color: #374151;
            color: #E5E7EB;
        }
        
        .dark .date-chip:hover {
            background-color: #4B5563;
        }
        
        .dark .date-chip.selected {
            background-color: #5D5CDE;
            color: white;
        }
        
        /* Comparison table styles */
        .comparison-table th,
        .comparison-table td {
            padding: 0.75rem 1rem;
            text-align: center;
        }
        
        .comparison-table th:first-child,
        .comparison-table td:first-child {
            text-align: left;
        }
        
        .comparison-table th {
            background-color: #F3F4F6;
            font-weight: 600;
            color: #374151;
        }
        
        .dark .comparison-table th {
            background-color: #374151;
            color: #F3F4F6;
        }
        
        .comparison-table tr:nth-child(even) {
            background-color: #F9FAFB;
        }
        
        .dark .comparison-table tr:nth-child(even) {
            background-color: #1F2937;
        }
        
        .comparison-table tr:hover {
            background-color: #F3F4F6;
        }
        
        .dark .comparison-table tr:hover {
            background-color: #374151;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen transition-colors duration-200">
    <div class="drawer-wrapper relative">
        <!-- Left Side Drawer -->
        <div id="left-drawer" class="fixed left-0 top-0 h-full w-64 bg-white dark:bg-gray-800 shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out z-40">
            <div class="p-4 h-full flex flex-col">
                <!-- App Logo in Drawer -->
                <div class="flex items-center mb-8 mt-4">
                    <div class="h-10 w-10 rounded-md bg-primary flex items-center justify-center text-white font-bold text-xl shadow-md">GG</div>
                    <span class="ml-2 font-semibold text-xl text-gray-900 dark:text-gray-100">GGOMES-LOG</span>
                </div>
                
                <!-- Navigation Links -->
                <nav class="flex-1">
                    <ul class="space-y-1">
                        <li>
                            <a href="#" class="drawer-link flex items-center p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150" data-page="dashboard">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                </svg>
                                Dashboard
                            </a>
                        </li>
                        <li>
                            <a href="#" class="drawer-link flex items-center p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150" data-page="entrega-hora">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                </svg>
                                Entrega por Hora
                            </a>
                        </li>
                        <li>
                            <a href="#" class="drawer-link flex items-center p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150" data-page="relatorios">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                Análises e Relatórios
                            </a>
                        </li>
                        <li>
                            <a href="#" class="drawer-link flex items-center p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150" data-page="historico">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Histórico
                            </a>
                        </li>
                        <li>
                            <a href="#" class="drawer-link flex items-center p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150" data-page="metas">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Metas e Desempenho
                            </a>
                        </li>
                        <li>
                            <a href="#" class="drawer-link flex items-center p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150" data-page="configuracoes">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Configurações
                            </a>
                        </li>
                    </ul>
                </nav>
                
                <!-- User section -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                    <div class="flex items-center">
                        <div class="h-9 w-9 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-blue-800 dark:text-blue-200 font-medium">GG</div>
                        <div class="ml-3">
                            <div class="font-medium text-gray-700 dark:text-gray-300">Gutemberg Gomes</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Gerente de Operações</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Drawer Backdrop -->
        <div id="drawer-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>
        
        <!-- Main Content -->
        <div class="min-h-screen flex flex-col">
            <!-- Top Navigation Bar -->
            <header class="bg-white dark:bg-gray-800 shadow-md">
                <div class="container mx-auto px-4 py-3">
                    <div class="flex justify-between items-center">
                        <!-- Left Side: Menu Button + Logo -->
                        <div class="flex items-center">
                            <button id="menu-button" class="mr-4 p-2 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                </svg>
                            </button>
                            <div class="flex items-center">
                                <div class="h-8 w-8 rounded-md bg-primary flex items-center justify-center text-white font-bold text-lg shadow-md">GG</div>
                                <span class="ml-2 font-semibold text-xl text-gray-900 dark:text-gray-100 hidden sm:inline-block">GGOMES-LOG</span>
                            </div>
                        </div>
                        
                        <!-- Current Date Display -->
                        <div class="flex items-center">
                            <div id="history-mode-indicator" class="hidden mr-2 history-mode-indicator">
                                <span>Modo Histórico</span>
                            </div>
                            <div class="hidden md:flex items-center text-gray-600 dark:text-gray-300 mr-4">
                                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <span id="header-date" class="text-sm font-medium"></span>
                            </div>
                            <div id="header-selected-date" class="hidden items-center mr-4 px-2 py-1 rounded-md bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">
                                <span id="selected-date-text" class="text-sm font-medium"></span>
                            </div>
                        </div>
                        
                        <!-- Right Side: Actions -->
                        <div class="flex items-center space-x-2 sm:space-x-4">
                            <!-- Search Button -->
                            <button id="search-button" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </button>
                            
                            <!-- Notifications -->
                            <div class="relative">
                                <button id="notifications-button" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                                    </svg>
                                    <span class="absolute top-0 right-0 h-4 w-4 bg-red-500 rounded-full text-xs text-white flex items-center justify-center">3</span>
                                </button>
                                
                                <!-- Notifications Dropdown -->
                                <div id="notifications-dropdown" class="absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 rounded-md shadow-lg z-20 hidden">
                                    <div class="p-3 border-b border-gray-200 dark:border-gray-700">
                                        <div class="flex justify-between items-center">
                                            <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300">Notificações</h3>
                                            <button class="text-xs text-primary hover:text-primary-600 dark:text-primary-300 dark:hover:text-primary-400">Marcar todas como lidas</button>
                                        </div>
                                    </div>
                                    <div class="max-h-80 overflow-y-auto dropdown-scroll">
                                        <a href="#" class="block p-3 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                                            <div class="flex items-start">
                                                <div class="flex-shrink-0 h-8 w-8 rounded-full bg-red-100 dark:bg-red-900 flex items-center justify-center text-red-500 dark:text-red-300">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                </div>
                                                <div class="ml-3">
                                                    <p class="text-sm text-gray-700 dark:text-gray-300"><span class="font-medium">Alerta:</span> Entrega abaixo de 50% do potencial na Frente 4001</p>
                                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Há 10 minutos</p>
                                                </div>
                                            </div>
                                        </a>
                                        <a href="#" class="block p-3 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                                            <div class="flex items-start">
                                                <div class="flex-shrink-0 h-8 w-8 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-blue-500 dark:text-blue-300">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                                                    </svg>
                                                </div>
                                                <div class="ml-3">
                                                    <p class="text-sm text-gray-700 dark:text-gray-300"><span class="font-medium">Nova mensagem:</span> Carlos Mendes comentou sobre o período 14:00-16:00</p>
                                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Há 30 minutos</p>
                                                </div>
                                            </div>
                                        </a>
                                        <a href="#" class="block p-3 hover:bg-gray-50 dark:hover:bg-gray-700">
                                            <div class="flex items-start">
                                                <div class="flex-shrink-0 h-8 w-8 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-500 dark:text-green-300">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                </div>
                                                <div class="ml-3">
                                                    <p class="text-sm text-gray-700 dark:text-gray-300"><span class="font-medium">Meta atingida:</span> Frente 4012 superou a meta diária</p>
                                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Há 1 hora</p>
                                                </div>
                                            </div>
                                        </a>
                                    </div>
                                    <div class="p-2 border-t border-gray-200 dark:border-gray-700">
                                        <a href="#" class="block text-center text-sm text-primary hover:text-primary-600 dark:text-primary-300 dark:hover:text-primary-400">Ver todas</a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Theme Toggle -->
                            <button id="theme-toggle" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none">
                                <!-- Sun icon -->
                                <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" />
                                </svg>
                                <!-- Moon icon -->
                                <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
                                </svg>
                            </button>
                            
                            <!-- Exit History Mode Button -->
                            <button id="exit-history-mode" class="hidden bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-md shadow transition duration-200 flex items-center">
                                <svg class="w-4 h-4 mr-1 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                </svg>
                                <span class="hidden sm:inline">Sair do Histórico</span>
                            </button>
                            
                            <!-- Save Button -->
                            <button id="save-data" class="bg-primary hover:bg-primary-600 text-white px-3 py-2 rounded-md shadow transition duration-200 flex items-center">
                                <svg class="w-4 h-4 mr-1 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                                </svg>
                                <span class="hidden sm:inline">Salvar</span>
                            </button>
                            
                            <!-- User Menu -->
                            <div class="relative">
                                <button id="user-menu-button" class="flex text-sm bg-gray-100 dark:bg-gray-700 rounded-full focus:outline-none">
                                    <div class="h-8 w-8 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-blue-800 dark:text-blue-200 font-medium">GG</div>
                                </button>
                                
                                <!-- User Menu Dropdown -->
                                <div id="user-menu-dropdown" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg z-20 hidden">
                                    <div class="py-1">
                                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Perfil</a>
                                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Configurações</a>
                                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Suporte</a>
                                        <div class="border-t border-gray-100 dark:border-gray-700"></div>
                                        <a href="#" class="block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700">Sair</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Search Modal -->
            <div id="search-modal" class="fixed inset-0 z-50 overflow-y-auto hidden">
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 dark:bg-gray-900 opacity-75"></div>
                    </div>
                    <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                        <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="sm:flex sm:items-start">
                                <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                                    <div class="flex items-center justify-between">
                                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Pesquisa Rápida</h3>
                                        <button id="close-search-modal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="mt-4">
                                        <div class="relative">
                                            <input type="text" id="global-search" class="w-full p-3 pl-10 text-gray-900 dark:text-gray-100 bg-gray-100 dark:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Pesquisar frentes, períodos, relatórios..." autofocus>
                                            <div class="absolute left-3 top-3 text-gray-400">
                                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                                </svg>
                                            </div>
                                        </div>
                                        <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                                            Pressione <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded">Enter</kbd> para pesquisar ou <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded">ESC</kbd> para fechar
                                        </div>
                                    </div>
                                    
                                    <!-- Search Results -->
                                    <div class="mt-4 max-h-96 overflow-y-auto">
                                        <h4 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Resultados Recentes</h4>
                                        <div class="space-y-2">
                                            <a href="#" class="block p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                                                <div class="flex items-center">
                                                    <div class="flex-shrink-0 h-8 w-8 rounded-md bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-blue-500 dark:text-blue-300">
                                                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                                        </svg>
                                                    </div>
                                                    <div class="ml-3">
                                                        <p class="text-sm font-medium text-gray-900 dark:text-gray-100">Frente 4001</p>
                                                        <p class="text-xs text-gray-500 dark:text-gray-400">Entrega por Hora > Período 06:00-08:00</p>
                                                    </div>
                                                </div>
                                            </a>
                                            <a href="#" class="block p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                                                <div class="flex items-center">
                                                    <div class="flex-shrink-0 h-8 w-8 rounded-md bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-500 dark:text-green-300">
                                                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                                        </svg>
                                                    </div>
                                                    <div class="ml-3">
                                                        <p class="text-sm font-medium text-gray-900 dark:text-gray-100">Relatório Mensal</p>
                                                        <p class="text-xs text-gray-500 dark:text-gray-400">Análises e Relatórios > Desempenho Mensal</p>
                                                    </div>
                                                </div>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" id="search-execute" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:ml-3 sm:w-auto sm:text-sm">
                                Pesquisar
                            </button>
                            <button type="button" id="search-cancel" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content Container -->
            <main class="flex-1 p-4 container mx-auto">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-soft p-6 mb-6">
                    <div class="mb-6 flex flex-col md:flex-row md:justify-between md:items-center space-y-4 md:space-y-0">
                        <div>
                            <h1 id="page-title" class="text-2xl font-bold text-gray-900 dark:text-gray-100">Dashboard</h1>
                            <p id="page-subtitle" class="text-gray-600 dark:text-gray-400 mt-1">Visão geral do desempenho da safra 2025</p>
                        </div>
                        <div class="flex flex-wrap space-x-2 items-center">
                            <div class="relative">
                                <select id="period-selector" class="appearance-none bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 py-2 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white dark:focus:bg-gray-800 focus:border-primary transition duration-150">
                                    <option value="daily">Hoje</option>
                                    <option value="weekly">Esta Semana</option>
                                    <option value="monthly">Este Mês</option>
                                    <option value="custom">Personalizado</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
                                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                        <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
                                    </svg>
                                </div>
                            </div>
                            <button id="custom-date-button" class="hidden items-center bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 py-2 px-4 rounded transition duration-150">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <span id="custom-date-range">Selecionar Datas</span>
                            </button>
                            <button id="export-dashboard" class="flex items-center bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 py-2 px-4 rounded transition duration-150">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                                Exportar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Dashboard Content -->
                    <div id="dashboard-content" class="page-content">
                        <!-- Dashboard Empty State (shown when no data available) -->
                        <div id="dashboard-empty-state" class="empty-state mb-6">
                            <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Sem dados para exibir</h3>
                            <p class="text-gray-500 dark:text-gray-400 mb-4">Ainda não há dados de entrega registrados no sistema.</p>
                            <a href="#" class="drawer-link inline-flex items-center px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-600 transition-colors" data-page="entrega-hora">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Registrar Entregas
                            </a>
                        </div>

                        <!-- Dashboard Stats Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="dashboard-card bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-all duration-300">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Entregue</p>
                                        <p class="text-2xl font-bold text-gray-900 dark:text-gray-100">0.0</p>
                                        <span class="inline-flex items-center text-sm font-medium text-gray-600 dark:text-gray-400">
                                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            Baseado em dados reais
                                        </span>
                                    </div>
                                    <div class="bg-primary-50 dark:bg-primary-900/30 p-3 rounded-full">
                                        <svg class="w-7 h-7 text-primary-500 dark:text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div class="bg-primary rounded-full h-2" style="width: 0%"></div>
                                    </div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">0% da meta mensal</p>
                                </div>
                            </div>
                            
                            <div class="dashboard-card bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-all duration-300">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Eficiência Média</p>
                                        <p class="text-2xl font-bold text-gray-900 dark:text-gray-100">0.0%</p>
                                        <span class="inline-flex items-center text-sm font-medium text-gray-600 dark:text-gray-400">
                                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            Entrega ÷ Potencial
                                        </span>
                                    </div>
                                    <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-full">
                                        <svg class="w-7 h-7 text-blue-500 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div class="bg-blue-500 rounded-full h-2" style="width: 0%"></div>
                                    </div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Meta: 85%</p>
                                </div>
                            </div>
                            
                            <div class="dashboard-card bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-all duration-300">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Viagens Realizadas</p>
                                        <p class="text-2xl font-bold text-gray-900 dark:text-gray-100">0</p>
                                        <span class="inline-flex items-center text-sm font-medium text-gray-600 dark:text-gray-400">
                                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            Total de todas as frentes
                                        </span>
                                    </div>
                                    <div class="bg-green-50 dark:bg-green-900/30 p-3 rounded-full">
                                        <svg class="w-7 h-7 text-green-500 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div class="bg-green-500 rounded-full h-2" style="width: 0%"></div>
                                    </div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">0% da meta mensal</p>
                                </div>
                            </div>
                            
                            <div class="dashboard-card bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-all duration-300">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Densidade Média</p>
                                        <p class="text-2xl font-bold text-gray-900 dark:text-gray-100">0.00</p>
                                        <span class="inline-flex items-center text-sm font-medium text-gray-600 dark:text-gray-400">
                                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            Média de todos os registros
                                        </span>
                                    </div>
                                    <div class="bg-purple-50 dark:bg-purple-900/30 p-3 rounded-full">
                                        <svg class="w-7 h-7 text-purple-500 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div class="bg-purple-500 rounded-full h-2" style="width: 0%"></div>
                                    </div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Meta: 65.00</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dashboard Main Charts -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                            <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Entrega por Período</h3>
                                    <div class="flex space-x-2">
                                        <button class="period-chart-option px-2 py-1 text-xs font-medium rounded bg-primary text-white" data-period="day">Dia</button>
                                        <button class="period-chart-option px-2 py-1 text-xs font-medium rounded bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600" data-period="week">Semana</button>
                                        <button class="period-chart-option px-2 py-1 text-xs font-medium rounded bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600" data-period="month">Mês</button>
                                    </div>
                                </div>
                                <div class="h-80">
                                    <canvas id="deliveryByPeriodChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Desempenho por Frente</h3>
                                <div class="h-80">
                                    <canvas id="frontPerformanceChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 24-Hour Production Chart -->
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm mb-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Produção 24 Horas por Frente</h3>
                            <div class="h-96">
                                <canvas id="production24HoursChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Dashboard Trips and Trucks per Hour -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Viagens por Frente</h3>
                                <div class="h-80">
                                    <canvas id="tripsByFrontChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Média de Caminhões/Hora por Frente</h3>
                                <div class="h-80">
                                    <canvas id="trucksPerHourChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Performance Metrics -->
                        <div class="grid grid-cols-1 gap-6 mb-6">
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Métricas de Desempenho</h3>
                                <div class="space-y-4">
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Eficiência Operacional</span>
                                            <span class="text-sm font-medium text-primary">0%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                            <div class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Utilização de Recursos</span>
                                            <span class="text-sm font-medium text-green-600 dark:text-green-400">0%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                            <div class="bg-green-600 dark:bg-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Cumprimento de Metas</span>
                                            <span class="text-sm font-medium text-yellow-600 dark:text-yellow-400">0%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                            <div class="bg-yellow-600 dark:bg-yellow-500 h-2.5 rounded-full" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Qualidade da Entrega</span>
                                            <span class="text-sm font-medium text-blue-600 dark:text-blue-400">0%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                            <div class="bg-blue-600 dark:bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                                    <div class="flex justify-between">
                                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Índice de Desempenho Geral</span>
                                        <span class="text-sm font-medium text-primary">0%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mt-2">
                                        <div class="total-percent-bar bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Entrega por Hora Content -->
                    <div id="entrega-hora-content" class="page-content hidden">
                        <div class="mb-6 flex flex-col md:flex-row md:justify-between md:items-center space-y-4 md:space-y-0">
                            <div>
                                <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Períodos de Entrega</h2>
                                <p class="text-gray-600 dark:text-gray-400 mt-1">Gerencie as entregas por períodos de 2 horas</p>
                            </div>
                            <div class="flex space-x-2">
                                <button id="clear-period" class="flex items-center bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 py-2 px-4 rounded transition duration-150">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                    Limpar Período
                                </button>
                                <button id="copy-previous" class="flex items-center bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 py-2 px-4 rounded transition duration-150">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                    Copiar Anterior
                                </button>
                                <div class="dropdown relative">
                                    <button id="export-dropdown-btn" class="flex items-center bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 py-2 px-4 rounded transition duration-150">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                        </svg>
                                        Exportar
                                    </button>
                                    <div id="export-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg z-20">
                                        <div class="py-1">
                                            <a href="#" id="export-json" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Exportar JSON</a>
                                            <a href="#" id="export-csv" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Exportar CSV</a>
                                            <a href="#" id="export-pdf" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Exportar PDF</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Date Selector for History Viewing -->
                        <div id="date-selector-container" class="mb-4 hidden">
                            <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg">
                                <h3 class="text-sm font-semibold text-blue-800 dark:text-blue-200 mb-2">Visualizando dados históricos</h3>
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-blue-600 dark:text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <span class="text-sm text-blue-800 dark:text-blue-200" id="current-historical-date">01/01/2025</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Period Selection Tabs -->
                        <div class="mb-6 overflow-x-auto">
                            <div class="flex space-x-2 min-w-max">
                                <button class="time-tab-btn px-4 py-2 text-sm font-medium rounded-md bg-primary text-white" data-period="06-08">06:00-08:00</button>
                                <button class="time-tab-btn px-4 py-2 text-sm font-medium rounded-md bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200" data-period="08-10">08:00-10:00</button>
                                <button class="time-tab-btn px-4 py-2 text-sm font-medium rounded-md bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200" data-period="10-12">10:00-12:00</button>
                                <button class="time-tab-btn px-4 py-2 text-sm font-medium rounded-md bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200" data-period="12-14">12:00-14:00</button>
                                <button class="time-tab-btn px-4 py-2 text-sm font-medium rounded-md bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200" data-period="14-16">14:00-16:00</button>
                                <button class="time-tab-btn px-4 py-2 text-sm font-medium rounded-md bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200" data-period="16-18">16:00-18:00</button>
                                <button class="time-tab-btn px-4 py-2 text-sm font-medium rounded-md bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200" data-period="18-20">18:00-20:00</button>
                                <button class="time-tab-btn px-4 py-2 text-sm font-medium rounded-md bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200" data-period="20-22">20:00-22:00</button>
                                <button class="time-tab-btn px-4 py-2 text-sm font-medium rounded-md bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200" data-period="22-00">22:00-00:00</button>
                                <button class="time-tab-btn px-4 py-2 text-sm font-medium rounded-md bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200" data-period="00-02">00:00-02:00</button>
                                <button class="time-tab-btn px-4 py-2 text-sm font-medium rounded-md bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200" data-period="02-04">02:00-04:00</button>
                                <button class="time-tab-btn px-4 py-2 text-sm font-medium rounded-md bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200" data-period="04-06">04:00-06:00</button>
                            </div>
                        </div>
                        
                        <!-- Loading Indicator -->
                        <div id="loading-indicator" class="p-10 text-center hidden">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
                            <p class="mt-2 text-gray-600 dark:text-gray-400">Carregando dados...</p>
                        </div>
                        
                        <!-- Time Period Content -->
                        <div id="time-period-content">
                            <!-- Content will be generated dynamically by the generateTimePeriodHTML() function -->
                        </div>
                    </div>
                    
                    <!-- Histórico Content (New Page) -->
                    <div id="historico-content" class="page-content hidden">
                        <div class="mb-6">
                            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Histórico de Registros</h2>
                            <p class="text-gray-600 dark:text-gray-400 mt-1">Visualize e compare dados de diferentes datas</p>
                        </div>
                        
                        <!-- Available Dates Section -->
                        <div class="mb-6 bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Datas Disponíveis</h3>
                            
                            <div id="no-history-message" class="hidden empty-state">
                                <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Sem dados históricos</h3>
                                <p class="text-gray-500 dark:text-gray-400 mb-4">Ainda não há registros salvos em diferentes datas.</p>
                                <p class="text-gray-500 dark:text-gray-400">Os registros diários são salvos automaticamente quando você registra dados de entrega.</p>
                            </div>
                            
                            <div id="dates-container" class="mb-4">
                                <!-- Date chips will be added here dynamically -->
                            </div>
                            
                            <div class="flex space-x-2">
                                <button id="view-selected-date" class="bg-primary hover:bg-primary-600 text-white px-4 py-2 rounded-md shadow transition duration-200 flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                    Visualizar Data Selecionada
                                </button>
                                
                                <button id="compare-dates" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md shadow transition duration-200 flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    Comparar Datas Selecionadas
                                </button>
                            </div>
                        </div>
                        
                        <!-- Comparison Section -->
                        <div id="comparison-container" class="hidden">
                            <div class="mb-6 bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Comparação de Datas</h3>
                                
                                <div id="selected-dates-comparison" class="mb-4 flex flex-wrap">
                                    <!-- Selected date chips for comparison will be displayed here -->
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                                        <h4 class="text-md font-semibold text-gray-900 dark:text-gray-100 mb-4">Total Entregue por Data</h4>
                                        <div class="h-80">
                                            <canvas id="comparisonDeliveryChart"></canvas>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                                        <h4 class="text-md font-semibold text-gray-900 dark:text-gray-100 mb-4">Eficiência por Data</h4>
                                        <div class="h-80">
                                            <canvas id="comparisonEfficiencyChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 comparison-table">
                                        <thead>
                                            <tr>
                                                <th>Métrica</th>
                                                <!-- Date headers will be added dynamically -->
                                            </tr>
                                        </thead>
                                        <tbody id="comparison-table-body">
                                            <!-- Table rows will be added dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="mt-6 flex justify-end">
                                    <button id="export-comparison" class="bg-primary hover:bg-primary-600 text-white px-4 py-2 rounded-md shadow transition duration-200 flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                        </svg>
                                        Exportar Comparação
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Daily Trends Chart -->
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Tendências Diárias</h3>
                            <div class="h-96">
                                <canvas id="dailyTrendsChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Relatórios Content -->
                    <div id="relatorios-content" class="page-content hidden">
                        <div class="mb-6 flex flex-col md:flex-row md:justify-between md:items-center space-y-4 md:space-y-0">
                            <div>
                                <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Análises e Relatórios</h2>
                                <p class="text-gray-600 dark:text-gray-400 mt-1">Relatórios detalhados de desempenho</p>
                            </div>
                            
                            <div class="flex flex-wrap space-x-2 items-center">
                                <div class="relative">
                                    <select id="report-type-selector" class="appearance-none bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 py-2 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white dark:focus:bg-gray-800 focus:border-primary transition duration-150">
                                        <option value="daily">Relatório Diário</option>
                                        <option value="weekly">Relatório Semanal</option>
                                        <option value="monthly">Relatório Mensal</option>
                                        <option value="custom">Período Personalizado</option>
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
                                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                            <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
                                        </svg>
                                    </div>
                                </div>
                                
                                <div class="relative">
                                    <select id="date-selector" class="appearance-none bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 py-2 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white dark:focus:bg-gray-800 focus:border-primary transition duration-150">
                                        <!-- Date options will be populated dynamically -->
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
                                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                            <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
                                        </svg>
                                    </div>
                                </div>
                                
                                <button id="custom-report-date-button" class="hidden items-center bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 py-2 px-4 rounded transition duration-150">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <span id="custom-report-range">Selecionar Datas</span>
                                </button>
                                
                                <button id="generate-report" class="flex items-center bg-primary hover:bg-primary-600 text-white py-2 px-4 rounded transition duration-150">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                    </svg>
                                    Gerar Relatório
                                </button>
                            </div>
                        </div>
                        
                        <!-- Report Loading Indicator -->
                        <div id="report-loading" class="p-10 text-center hidden">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
                            <p class="mt-2 text-gray-600 dark:text-gray-400">Gerando relatório...</p>
                        </div>
                        
                        <!-- Report Content -->
                        <div id="report-content" class="hidden">
                            <!-- Report Header -->
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm mb-6">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100" id="report-title">Relatório Diário</h3>
                                        <p class="text-gray-600 dark:text-gray-400 mt-1" id="report-period">Período: 01/01/2025</p>
                                    </div>
                                    <div>
                                        <button id="export-report" class="flex items-center bg-primary hover:bg-primary-600 text-white py-2 px-4 rounded transition duration-150">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                            </svg>
                                            Exportar
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Report Summary -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                                    <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Entregue</h4>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-gray-100" id="report-total-delivered">0.0</p>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mt-2">
                                        <div class="bg-primary rounded-full h-2" id="report-total-delivered-bar" style="width: 0%"></div>
                                    </div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="report-total-delivered-percent">0% da meta</p>
                                </div>
                                
                                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                                    <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">Eficiência Média</h4>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-gray-100" id="report-efficiency">0.0%</p>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mt-2">
                                        <div class="bg-blue-500 rounded-full h-2" id="report-efficiency-bar" style="width: 0%"></div>
                                    </div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Meta: 85%</p>
                                </div>
                                
                                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                                    <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">Viagens Realizadas</h4>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-gray-100" id="report-trips">0</p>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mt-2">
                                        <div class="bg-green-500 rounded-full h-2" id="report-trips-bar" style="width: 0%"></div>
                                    </div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="report-trips-percent">0% da meta</p>
                                </div>
                                
                                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                                    <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">Densidade Média</h4>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-gray-100" id="report-density">0.00</p>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mt-2">
                                        <div class="bg-purple-500 rounded-full h-2" id="report-density-bar" style="width: 0%"></div>
                                    </div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Meta: 65.00</p>
                                </div>
                            </div>
                            
                            <!-- Report Charts -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                                    <h4 class="text-md font-semibold text-gray-900 dark:text-gray-100 mb-4">Entrega por Período</h4>
                                    <div class="h-80">
                                        <canvas id="reportDeliveryChart"></canvas>
                                    </div>
                                </div>
                                
                                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                                    <h4 class="text-md font-semibold text-gray-900 dark:text-gray-100 mb-4">Desempenho por Frente</h4>
                                    <div class="h-80">
                                        <canvas id="reportPerformanceChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Report Table -->
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                                <h4 class="text-md font-semibold text-gray-900 dark:text-gray-100 mb-4">Detalhes por Frente</h4>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-800">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Frente</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Entrega (ton)</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Potencial (ton)</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Eficiência</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Viagens</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Densidade Média</th>
                                            </tr>
                                        </thead>
                                        <tbody id="report-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            <!-- Table rows will be dynamically added here -->
                                        </tbody>
                                        <tfoot class="bg-gray-50 dark:bg-gray-700 font-semibold">
                                            <tr>
                                                <td class="px-4 py-3 whitespace-nowrap">TOTAL</td>
                                                <td id="report-footer-delivery" class="px-4 py-3 whitespace-nowrap">0.0</td>
                                                <td id="report-footer-potential" class="px-4 py-3 whitespace-nowrap">0.0</td>
                                                <td id="report-footer-efficiency" class="px-4 py-3 whitespace-nowrap">0.0%</td>
                                                <td id="report-footer-trips" class="px-4 py-3 whitespace-nowrap">0</td>
                                                <td id="report-footer-density" class="px-4 py-3 whitespace-nowrap">0.00</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- No Data Message -->
                        <div id="no-report-data-message" class="empty-state">
                            <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Sem dados para o relatório</h3>
                            <p class="text-gray-500 dark:text-gray-400 mb-4">Selecione um período e gere um relatório para visualizar as informações.</p>
                        </div>
                    </div>
                    
                    <!-- Metas Content -->
                    <div id="metas-content" class="page-content hidden">
                        <div class="text-center py-10">
                            <div class="inline-block p-6 bg-primary/10 dark:bg-primary/20 rounded-lg">
                                <svg class="w-16 h-16 mx-auto text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <h2 class="mt-4 text-xl font-bold text-gray-900 dark:text-gray-100">Metas e Desempenho</h2>
                                <p class="mt-2 text-gray-600 dark:text-gray-400">Página em desenvolvimento. Acompanhamento de metas e desempenho estarão disponíveis em breve.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configurações Content -->
                    <div id="configuracoes-content" class="page-content hidden">
                        <div class="max-w-2xl mx-auto">
                            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-6">Configurações do Sistema</h2>
                            
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden mb-6">
                                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                                    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Preferências Gerais</h3>
                                </div>
                                <div class="p-4 space-y-4">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Salvar Automaticamente</h4>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">Salva automaticamente as alterações</p>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="auto-save-toggle" class="sr-only peer" checked>
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                                        </label>
                                    </div>
                                    
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Intervalo de Salvamento (minutos)</h4>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">Frequência do salvamento automático</p>
                                        </div>
                                        <div class="w-20">
                                            <input type="number" id="auto-save-interval" class="w-full px-3 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" min="1" max="60" value="5">
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Modo Escuro</h4>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">Alterna entre o tema claro e escuro</p>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="dark-mode-toggle" class="sr-only peer">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                                        </label>
                                    </div>
                                    
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Salvamento Diário Automático</h4>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">Salva automaticamente os registros diários para histórico</p>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="auto-daily-save-toggle" class="sr-only peer" checked>
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden mb-6">
                                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                                    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Notificações e Alertas</h3>
                                </div>
                                <div class="p-4 space-y-4">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Limiar de Alerta (%)</h4>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">Porcentagem abaixo da meta para disparar alerta</p>
                                        </div>
                                        <div class="w-20">
                                            <input type="number" id="alert-threshold" class="w-full px-3 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" min="1" max="50" value="10">
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Alertas Sonoros</h4>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">Emite sons para alertas importantes</p>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="sound-alert-toggle" class="sr-only peer">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                                        </label>
                                    </div>
                                    
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Alertas Visuais</h4>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">Mostra notificações na interface</p>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="visual-alert-toggle" class="sr-only peer" checked>
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden mb-6">
                                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                                    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Gestão de Dados</h3>
                                </div>
                                <div class="p-4 space-y-4">
                                    <div>
                                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Gerenciamento de Histórico</h4>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Gerencie dados históricos salvos no sistema</p>
                                        
                                        <div class="flex flex-wrap space-x-2">
                                            <button id="export-all-history" class="mb-2 flex items-center bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-md shadow transition duration-200">
                                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                                </svg>
                                                Exportar Todo Histórico
                                            </button>
                                            
                                            <button id="clear-history" class="mb-2 flex items-center bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-md shadow transition duration-200">
                                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                </svg>
                                                Limpar Histórico
                                            </button>
                                            
                                            <label for="import-history" class="mb-2 flex items-center bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-md shadow transition duration-200 cursor-pointer">
                                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                                </svg>
                                                Importar Histórico
                                                <input id="import-history" type="file" accept=".json" class="hidden">
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="pt-2">
                                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Backup e Restauração</h4>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Crie backups e restaure dados do sistema</p>
                                        
                                        <div class="flex flex-wrap space-x-2">
                                            <button id="create-backup" class="mb-2 flex items-center bg-primary hover:bg-primary-600 text-white px-3 py-2 rounded-md shadow transition duration-200">
                                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                                </svg>
                                                Criar Backup
                                            </button>
                                            
                                            <label for="restore-backup" class="mb-2 flex items-center bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-md shadow transition duration-200 cursor-pointer">
                                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                                </svg>
                                                Restaurar Backup
                                                <input id="restore-backup" type="file" accept=".json" class="hidden">
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3">
                                <button id="restore-defaults" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary transition duration-150">
                                    Restaurar Padrões
                                </button>
                                <button id="save-config" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 transition duration-150">
                                    Salvar Configurações
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            
            <!-- Footer -->
            <footer class="bg-white dark:bg-gray-800 shadow-md mt-auto">
                <div class="container mx-auto px-4 py-4">
                    <div class="flex flex-col md:flex-row justify-between items-center">
                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-4 md:mb-0">
                            © 2025 GGOMES-LOG - Gestão de Entrega de Safra
                        </div>
                        <div class="flex space-x-4">
                            <a href="#" class="text-sm text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary-300 transition-colors duration-150">Termos de Uso</a>
                            <a href="#" class="text-sm text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary-300 transition-colors duration-150">Política de Privacidade</a>
                            <a href="#" class="text-sm text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary-300 transition-colors duration-150">Suporte</a>
                            <span class="text-sm text-gray-400 dark:text-gray-500">Versão 2.1.0</span>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>
    
    <!-- Calendar Modal -->
    <div id="calendar-modal" class="fixed inset-0 z-50 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 dark:bg-gray-900 opacity-75"></div>
            </div>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Selecionar Período</h3>
                                <button id="close-calendar-modal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="mt-4">
                                <div class="flex justify-between items-center mb-4">
                                    <button id="prev-month" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                        </svg>
                                    </button>
                                    <div id="current-month-year" class="text-lg font-semibold text-gray-900 dark:text-gray-100">Julho 2024</div>
                                    <button id="next-month" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </button>
                                </div>
                                
                                <div class="grid grid-cols-7 gap-1 text-center text-xs font-medium text-gray-500 dark:text-gray-400">
                                    <div>Dom</div>
                                    <div>Seg</div>
                                    <div>Ter</div>
                                    <div>Qua</div>
                                    <div>Qui</div>
                                    <div>Sex</div>
                                    <div>Sáb</div>
                                </div>
                                
                                <div id="calendar-days" class="grid grid-cols-7 gap-1 mt-2">
                                    <!-- Calendar days will be generated here -->
                                </div>
                                
                                <div class="mt-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Período Selecionado</span>
                                    </div>
                                    <div class="flex space-x-2">
                                        <div class="flex-1">
                                            <label for="start-date" class="block text-xs text-gray-500 dark:text-gray-400">Início</label>
                                            <input type="text" id="start-date" class="block w-full p-2 text-sm bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md" readonly>
                                        </div>
                                        <div class="flex-1">
                                            <label for="end-date" class="block text-xs text-gray-500 dark:text-gray-400">Fim</label>
                                            <input type="text" id="end-date" class="block w-full p-2 text-sm bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="apply-date-range" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:ml-3 sm:w-auto sm:text-sm">
                        Aplicar
                    </button>
                    <button type="button" id="cancel-date-range" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="keyboard-shortcuts-modal" class="fixed inset-0 z-50 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 dark:bg-gray-900 opacity-75"></div>
            </div>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Atalhos de Teclado</h3>
                                <button id="close-shortcuts-modal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="mt-4">
                                <div class="border-b border-gray-200 dark:border-gray-700">
                                    <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Navegação</h4>
                                    <ul class="mb-4 space-y-2">
                                        <li class="flex justify-between items-center">
                                            <span class="text-gray-700 dark:text-gray-300">Abrir Menu</span>
                                            <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">Alt + M</span>
                                        </li>
                                        <li class="flex justify-between items-center">
                                            <span class="text-gray-700 dark:text-gray-300">Pesquisar</span>
                                            <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">Ctrl + K</span>
                                        </li>
                                        <li class="flex justify-between items-center">
                                            <span class="text-gray-700 dark:text-gray-300">Dashboard</span>
                                            <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">Alt + 1</span>
                                        </li>
                                        <li class="flex justify-between items-center">
                                            <span class="text-gray-700 dark:text-gray-300">Entrega por Hora</span>
                                            <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">Alt + 2</span>
                                        </li>
                                        <li class="flex justify-between items-center">
                                            <span class="text-gray-700 dark:text-gray-300">Análises</span>
                                            <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">Alt + 3</span>
                                        </li>
                                    </ul>
                                </div>
                                
                                <div class="border-b border-gray-200 dark:border-gray-700 pt-4">
                                    <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Ações</h4>
                                    <ul class="mb-4 space-y-2">
                                        <li class="flex justify-between items-center">
                                            <span class="text-gray-700 dark:text-gray-300">Salvar Dados</span>
                                            <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">Ctrl + S</span>
                                        </li>
                                        <li class="flex justify-between items-center">
                                            <span class="text-gray-700 dark:text-gray-300">Alterar Tema</span>
                                            <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">Ctrl + D</span>
                                        </li>
                                        <li class="flex justify-between items-center">
                                            <span class="text-gray-700 dark:text-gray-300">Exportar Dados</span>
                                            <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">Ctrl + E</span>
                                        </li>
                                        <li class="flex justify-between items-center">
                                            <span class="text-gray-700 dark:text-gray-300">Adicionar Nova Frente</span>
                                            <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">Ctrl + N</span>
                                        </li>
                                    </ul>
                                </div>
                                
                                <div class="pt-4">
                                    <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Edição de Dados</h4>
                                    <ul class="mb-2 space-y-2">
                                        <li class="flex justify-between items-center">
                                            <span class="text-gray-700 dark:text-gray-300">Próximo Campo</span>
                                            <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">Tab</span>
                                        </li>
                                        <li class="flex justify-between items-center">
                                            <span class="text-gray-700 dark:text-gray-300">Campo Anterior</span>
                                            <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">Shift + Tab</span>
                                        </li>
                                        <li class="flex justify-between items-center">
                                            <span class="text-gray-700 dark:text-gray-300">Aumentar Valor</span>
                                            <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">↑</span>
                                        </li>
                                        <li class="flex justify-between items-center">
                                            <span class="text-gray-700 dark:text-gray-300">Diminuir Valor</span>
                                            <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">↓</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 flex justify-end">
                    <button type="button" id="close-shortcuts-button" class="inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:w-auto sm:text-sm">
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col-reverse space-y-reverse space-y-2"></div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full relative z-10 shadow-lg">
            <h3 id="modal-title" class="text-lg font-bold text-gray-900 dark:text-gray-100 mb-4">Confirmação</h3>
            <p id="modal-message" class="text-gray-700 dark:text-gray-300 mb-6">Tem certeza que deseja realizar esta ação?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-200">
                    Cancelar
                </button>
                <button id="modal-confirm" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-600 transition duration-200">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        const state = {
            // Front data
            fronts: ['4001', '4002', '4007', '4009'],
            hours: [6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 0, 1, 2, 3, 4, 5],
            timePeriodsMap: {
                '06-08': [6, 7],
                '08-10': [8, 9],
                '10-12': [10, 11],
                '12-14': [12, 13],
                '14-16': [14, 15],
                '16-18': [16, 17],
                '18-20': [18, 19],
                '20-22': [20, 21],
                '22-00': [22, 23],
                '00-02': [0, 1],
                '02-04': [2, 3],
                '04-06': [4, 5]
            },
            
            // Delivery data
            density: {},
            trips: {},
            delivery: {},
            potential: {},
            
            // Period summaries
            twoHourDelivery: {},
            twoHourPotential: {},
            difference: {},
            
            // Charts
            charts: {
                frontSummary: null,
                hourlyPerformance: null,
                efficiencyGauge: null,
                periodComparison: null,
                deliveryByPeriod: null,
                frontPerformance: null,
                tripsByFront: null, // Chart for trips by front
                trucksPerHour: null, // Chart for trucks per hour
                production24HoursChart: null, // New chart for 24-hour production by front
                comparisonDeliveryChart: null, // Chart for comparing delivery across dates
                comparisonEfficiencyChart: null, // Chart for comparing efficiency across dates
                dailyTrendsChart: null, // Chart for daily trends
                reportDeliveryChart: null, // Chart for report delivery
                reportPerformanceChart: null // Chart for report performance
            },
            
            // Current active period
            activePeriod: '06-08',
            currentPage: 'dashboard',
            
            // Config
            config: {
                autoSave: true,
                autoSaveInterval: 5, // minutes
                darkMode: false,
                alertThreshold: 10, // %
                soundAlerts: false,
                visualAlerts: true,
                autoDailySave: true // Auto save daily records
            },
            
            // Date & calendar
            calendar: {
                startDate: null,
                endDate: null,
                currentMonth: new Date().getMonth(),
                currentYear: new Date().getFullYear(),
                selectedDate: new Date() // Current selected date
            },
            
            // Historical data
            dailyHistory: {}, // Stores the daily records
            selectedHistoryDates: [], // For comparison
            
            // History compare mode
            historyCompareMode: false,
            
            // Action history for undo/redo
            history: [],
            
            // Tracks if user has entered any data
            hasData: false
        };
        
        // DOM Ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeDataStructures();
            loadConfig();
            setupDarkMode();
            loadInitialData();
            setupUI();
            setupEventListeners();
            calculateDelivery();
            calculateTwoHourTotals();
            initializeCharts();
            updateDateTimeWidgets();
            
            // Set up auto-save interval
            if (state.config.autoSave) {
                setInterval(saveData, state.config.autoSaveInterval * 60 * 1000);
            }
            
            // Show dashboard as default
            showPage('dashboard');
            
            // Auto-load saved data if available
            loadSavedData();
            
            // Load historical data
            loadHistoricalData();
            
            // Initialize the export dropdown toggle
            document.getElementById('export-dropdown-btn')?.addEventListener('click', function() {
                const dropdown = document.getElementById('export-dropdown');
                if (dropdown) {
                    toggleElement(dropdown);
                }
            });
            
            // Close dropdown when clicking elsewhere
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#export-dropdown-btn')) {
                    const dropdown = document.getElementById('export-dropdown');
                    if (dropdown && !dropdown.classList.contains('hidden')) {
                        toggleElement(dropdown, false);
                    }
                }
            });
            
            // Connect restore defaults button
            document.getElementById('restore-defaults')?.addEventListener('click', function() {
                showConfirmationModal(
                    'Restaurar Padrões',
                    'Tem certeza que deseja restaurar todas as configurações para os valores padrão?',
                    restoreDefaultConfig
                );
            });
            
            // Connect save config button
            document.getElementById('save-config')?.addEventListener('click', function() {
                updateConfigFromUI();
                saveConfig();
                showToast('Configurações salvas com sucesso!', 'success');
            });
            
            // Connect exit history mode button
            document.getElementById('exit-history-mode')?.addEventListener('click', function() {
                exitHistoryMode();
            });
            
            // Connect view selected date button
            document.getElementById('view-selected-date')?.addEventListener('click', function() {
                if (state.selectedHistoryDates.length === 0) {
                    showToast('Selecione pelo menos uma data para visualizar', 'warning');
                    return;
                }
                
                // Load data for the selected date
                loadDailyData(state.selectedHistoryDates[0]);
                
                // Show entrega-hora page
                showPage('entrega-hora');
            });
            
            // Connect compare dates button
            document.getElementById('compare-dates')?.addEventListener('click', function() {
                if (state.selectedHistoryDates.length < 2) {
                    showToast('Selecione pelo menos duas datas para comparar', 'warning');
                    return;
                }
                
                // Show the comparison container
                generateComparisonView();
                
                // Update comparison charts
                updateComparisonCharts();
            });
            
            // Connect clear history button
            document.getElementById('clear-history')?.addEventListener('click', function() {
                showConfirmationModal(
                    'Limpar Histórico',
                    'Tem certeza que deseja limpar todo o histórico de dados? Esta ação não pode ser desfeita.',
                    clearHistoricalData
                );
            });
            
            // Connect export all history button
            document.getElementById('export-all-history')?.addEventListener('click', exportAllHistory);
            
            // Connect import history input
            document.getElementById('import-history')?.addEventListener('change', importHistory);
            
            // Connect create backup button
            document.getElementById('create-backup')?.addEventListener('click', createBackup);
            
            // Connect restore backup input
            document.getElementById('restore-backup')?.addEventListener('change', restoreBackup);
            
            // Connect export comparison button
            document.getElementById('export-comparison')?.addEventListener('click', exportComparison);
            
            // Connect report generation button
            document.getElementById('generate-report')?.addEventListener('click', generateReport);
            
            // Connect export report button
            document.getElementById('export-report')?.addEventListener('click', exportReport);
            
            // Auto-daily toggle
            document.getElementById('auto-daily-save-toggle')?.addEventListener('change', function() {
                state.config.autoDailySave = this.checked;
                saveConfig();
            });

            // Initialize keyboard shortcuts
            setupKeyboardShortcuts();
        });
        
        function restoreDefaultConfig() {
            // Reset to default values
            state.config = {
                autoSave: true,
                autoSaveInterval: 5,
                darkMode: false,
                alertThreshold: 10,
                soundAlerts: false,
                visualAlerts: true,
                autoDailySave: true
            };
            
            // Update UI with restored values
            updateUIFromConfig();
            
            // Apply dark mode setting
            updateDarkMode();
            
            // Save the restored config
            saveConfig();
            
            showToast('Configurações restauradas para os valores padrão', 'success');
        }
        
        // Initialize data structures
        function initializeDataStructures() {
            // Initialize delivery data structures
            for (const front of state.fronts) {
                state.density[front] = {};
                state.trips[front] = {};
                state.delivery[front] = {};
                state.potential[front] = {};
                
                for (const hour of state.hours) {
                    state.density[front][hour] = 0;
                    state.trips[front][hour] = 0;
                    state.delivery[front][hour] = 0;
                    state.potential[front][hour] = 0;
                }
            }
            
            // Initialize period summaries
            for (const period in state.timePeriodsMap) {
                state.twoHourDelivery[period] = {};
                state.twoHourPotential[period] = {};
                state.difference[period] = {};
                
                for (const front of state.fronts) {
                    state.twoHourDelivery[period][front] = 0;
                    state.twoHourPotential[period][front] = 0;
                    state.difference[period][front] = 0;
                }
            }
        }
        
        // Setup Initial UI
        function setupUI() {
            // Setup navigation drawer links
            document.querySelectorAll('.drawer-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    showPage(page);
                    toggleDrawer(false);
                });
            });
            
            // Setup date/time widgets
            setInterval(updateDateTimeWidgets, 60000); // Update every minute
            
            // Setup dropdown event listeners
            setupDropdowns();
            
            // Set up period chart options
            document.querySelectorAll('.period-chart-option').forEach(option => {
                option.addEventListener('click', function() {
                    const period = this.getAttribute('data-period');
                    updatePeriodChart(period);
                    
                    // Update active state
                    document.querySelectorAll('.period-chart-option').forEach(btn => {
                        btn.classList.remove('bg-primary', 'text-white');
                        btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    });
                    this.classList.add('bg-primary', 'text-white');
                    this.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                });
            });
            
            // Calendar setup
            setupCalendarModal();

            // Setup date selector for reports
            setupDateSelector();

            // Check for initial empty state
            updateEmptyStateVisibility();
        }
        
        // Setup Date Selector for Reports
        function setupDateSelector() {
            const reportTypeSelector = document.getElementById('report-type-selector');
            const dateSelector = document.getElementById('date-selector');
            const customReportDateButton = document.getElementById('custom-report-date-button');
            
            if (!reportTypeSelector || !dateSelector || !customReportDateButton) return;
            
            // Update date selector based on report type
            reportTypeSelector.addEventListener('change', function() {
                const reportType = this.value;
                dateSelector.innerHTML = ''; // Clear options
                
                switch (reportType) {
                    case 'daily':
                        // Past 7 days
                        for (let i = 0; i < 7; i++) {
                            const date = new Date();
                            date.setDate(date.getDate() - i);
                            const dateStr = formatDate(date);
                            const option = document.createElement('option');
                            option.value = formatDateISO(date);
                            option.textContent = i === 0 ? 'Hoje' : dateStr;
                            dateSelector.appendChild(option);
                        }
                        dateSelector.classList.remove('hidden');
                        customReportDateButton.classList.add('hidden');
                        break;
                        
                    case 'weekly':
                        // Past 4 weeks
                        for (let i = 0; i < 4; i++) {
                            const endDate = new Date();
                            endDate.setDate(endDate.getDate() - (i * 7));
                            const startDate = new Date(endDate);
                            startDate.setDate(startDate.getDate() - 6);
                            
                            const dateRangeStr = `${formatDate(startDate)} - ${formatDate(endDate)}`;
                            const option = document.createElement('option');
                            option.value = `${formatDateISO(startDate)}_${formatDateISO(endDate)}`;
                            option.textContent = i === 0 ? 'Esta Semana' : dateRangeStr;
                            dateSelector.appendChild(option);
                        }
                        dateSelector.classList.remove('hidden');
                        customReportDateButton.classList.add('hidden');
                        break;
                        
                    case 'monthly':
                        // Past 3 months
                        for (let i = 0; i < 3; i++) {
                            const date = new Date();
                            date.setDate(1); // First day of current month
                            date.setMonth(date.getMonth() - i);
                            
                            const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                            const monthStr = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
                            
                            const option = document.createElement('option');
                            option.value = formatDateISO(date).substring(0, 7); // YYYY-MM
                            option.textContent = i === 0 ? 'Este Mês' : monthStr;
                            dateSelector.appendChild(option);
                        }
                        dateSelector.classList.remove('hidden');
                        customReportDateButton.classList.add('hidden');
                        break;
                        
                    case 'custom':
                        dateSelector.classList.add('hidden');
                        customReportDateButton.classList.remove('hidden');
                        customReportDateButton.classList.add('flex');
                        break;
                }
            });
            
            // Initialize with daily report type
            reportTypeSelector.dispatchEvent(new Event('change'));
        }
        
        // Setup Dropdowns
        function setupDropdowns() {
            // Notifications dropdown
            const notificationsButton = document.getElementById('notifications-button');
            const notificationsDropdown = document.getElementById('notifications-dropdown');
            
            if (notificationsButton && notificationsDropdown) {
                notificationsButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleElement(notificationsDropdown);
                });
            }
            
            // User menu dropdown
            const userMenuButton = document.getElementById('user-menu-button');
            const userMenuDropdown = document.getElementById('user-menu-dropdown');
            
            if (userMenuButton && userMenuDropdown) {
                userMenuButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleElement(userMenuDropdown);
                });
            }
            
            // Close dropdowns when clicking elsewhere
            document.addEventListener('click', function(e) {
                if (notificationsDropdown && notificationsDropdown.classList.contains('block')) {
                    toggleElement(notificationsDropdown, false);
                }
                
                if (userMenuDropdown && userMenuDropdown.classList.contains('block')) {
                    toggleElement(userMenuDropdown, false);
                }
            });
        }
        
        // Toggle element visibility
        function toggleElement(element, show) {
            if (!element) return;
            
            if (show === undefined) {
                element.classList.toggle('hidden');
                element.classList.toggle('block');
            } else if (show) {
                element.classList.remove('hidden');
                element.classList.add('block');
            } else {
                element.classList.add('hidden');
                element.classList.remove('block');
            }
        }
        
        // Setup Calendar Modal
        function setupCalendarModal() {
            const customDateButton = document.getElementById('custom-date-button');
            const calendarModal = document.getElementById('calendar-modal');
            const closeCalendarModal = document.getElementById('close-calendar-modal');
            const cancelDateRange = document.getElementById('cancel-date-range');
            const applyDateRange = document.getElementById('apply-date-range');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            
            // Initialize calendar data
            state.calendar.startDate = new Date();
            state.calendar.endDate = new Date();
            
            // Show custom date button when custom period is selected
            document.getElementById('period-selector')?.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customDateButton.classList.remove('hidden');
                    customDateButton.classList.add('flex');
                } else {
                    customDateButton.classList.add('hidden');
                    customDateButton.classList.remove('flex');
                }
            });
            
            // Show calendar modal
            if (customDateButton) {
                customDateButton.addEventListener('click', function() {
                    generateCalendarDays();
                    toggleElement(calendarModal, true);
                });
            }
            
            // Close calendar modal
            if (closeCalendarModal) {
                closeCalendarModal.addEventListener('click', function() {
                    toggleElement(calendarModal, false);
                });
            }
            
            if (cancelDateRange) {
                cancelDateRange.addEventListener('click', function() {
                    toggleElement(calendarModal, false);
                });
            }
            
            // Apply date range
            if (applyDateRange) {
                applyDateRange.addEventListener('click', function() {
                    if (state.calendar.startDate && state.calendar.endDate) {
                        const startDateStr = formatDate(state.calendar.startDate);
                        const endDateStr = formatDate(state.calendar.endDate);
                        
                        document.getElementById('custom-date-range').textContent = `${startDateStr} - ${endDateStr}`;
                    }
                    
                    toggleElement(calendarModal, false);
                });
            }
            
            // Navigate months
            if (prevMonthBtn) {
                prevMonthBtn.addEventListener('click', function() {
                    state.calendar.currentMonth--;
                    if (state.calendar.currentMonth < 0) {
                        state.calendar.currentMonth = 11;
                        state.calendar.currentYear--;
                    }
                    generateCalendarDays();
                });
            }
            
            if (nextMonthBtn) {
                nextMonthBtn.addEventListener('click', function() {
                    state.calendar.currentMonth++;
                    if (state.calendar.currentMonth > 11) {
                        state.calendar.currentMonth = 0;
                        state.calendar.currentYear++;
                    }
                    generateCalendarDays();
                });
            }
        }
        
        // Generate Calendar Days
        function generateCalendarDays() {
            const calendarDays = document.getElementById('calendar-days');
            const currentMonthYear = document.getElementById('current-month-year');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            
            if (!calendarDays || !currentMonthYear) return;
            
            // Clear previous calendar
            calendarDays.innerHTML = '';
            
            // Set current month and year
            const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            currentMonthYear.textContent = `${monthNames[state.calendar.currentMonth]} ${state.calendar.currentYear}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(state.calendar.currentYear, state.calendar.currentMonth, 1).getDay();
            const daysInMonth = new Date(state.calendar.currentYear, state.calendar.currentMonth + 1, 0).getDate();
            
            // Add empty cells for days before the first day of month
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'h-10';
                calendarDays.appendChild(emptyCell);
            }
            
            // Add days
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                const currentDate = new Date(state.calendar.currentYear, state.calendar.currentMonth, day);
                currentDate.setHours(0, 0, 0, 0);
                
                dayCell.className = 'calendar-day h-10 flex items-center justify-center rounded-full cursor-pointer';
                
                // Highlight current day
                if (currentDate.getTime() === today.getTime()) {
                    dayCell.classList.add('current');
                }
                
                // Highlight selected range
                if (state.calendar.startDate && state.calendar.endDate) {
                    if (currentDate.getTime() >= state.calendar.startDate.getTime() && 
                        currentDate.getTime() <= state.calendar.endDate.getTime()) {
                        dayCell.classList.add('selected');
                    }
                }
                
                dayCell.textContent = day;
                
                // Add click event to select date range
                dayCell.addEventListener('click', function() {
                    if (!state.calendar.startDate || (state.calendar.startDate && state.calendar.endDate)) {
                        // Start new selection
                        state.calendar.startDate = new Date(state.calendar.currentYear, state.calendar.currentMonth, day);
                        state.calendar.endDate = null;
                        
                        // Update inputs
                        if (startDateInput) startDateInput.value = formatDate(state.calendar.startDate);
                        if (endDateInput) endDateInput.value = '';
                    } else {
                        // Complete selection
                        const clickedDate = new Date(state.calendar.currentYear, state.calendar.currentMonth, day);
                        
                        // Ensure end date is after start date
                        if (clickedDate >= state.calendar.startDate) {
                            state.calendar.endDate = clickedDate;
                        } else {
                            state.calendar.endDate = state.calendar.startDate;
                            state.calendar.startDate = clickedDate;
                        }
                        
                        // Update inputs
                        if (startDateInput) startDateInput.value = formatDate(state.calendar.startDate);
                        if (endDateInput) endDateInput.value = formatDate(state.calendar.endDate);
                    }
                    
                    // Redraw calendar to show selection
                    generateCalendarDays();
                });
                
                calendarDays.appendChild(dayCell);
            }
        }
        
        // Format date to dd/mm/yyyy
        function formatDate(date) {
            if (!date) return '';
            return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
        }
        
        // Format date to YYYY-MM-DD for storage keys
        function formatDateISO(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Update Date/Time Widgets
        function updateDateTimeWidgets() {
            const headerDate = document.getElementById('header-date');
            
            const now = new Date();
            const dateOptions = { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' };
            
            const formattedDate = now.toLocaleDateString('pt-BR', dateOptions);
            
            if (headerDate) headerDate.textContent = formattedDate;
            
            // If in history mode, update the selected date display
            if (state.historyCompareMode) {
                const selectedDateText = document.getElementById('selected-date-text');
                if (selectedDateText) {
                    const date = state.calendar.selectedDate;
                    selectedDateText.textContent = formatDate(date);
                }
            }
        }
        
        // Setup Keyboard Shortcuts
        function setupKeyboardShortcuts() {
            // Listen for keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl + K for search
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    toggleSearchModal(true);
                }
                
                // Alt + M for menu
                if (e.altKey && e.key === 'm') {
                    e.preventDefault();
                    toggleDrawer();
                }
                
                // Ctrl + S for save
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveData();
                    showToast('Dados salvos com sucesso!', 'success');
                }
                
                // Alt + 1-7 for navigation
                if (e.altKey && !isNaN(parseInt(e.key)) && parseInt(e.key) >= 1 && parseInt(e.key) <= 7) {
                    e.preventDefault();
                    const pages = ['dashboard', 'entrega-hora', 'relatorios', 'historico', 'metas', 'configuracoes'];
                    const index = parseInt(e.key) - 1;
                    
                    if (index < pages.length) {
                        showPage(pages[index]);
                    }
                }
                
                // Ctrl + D for dark mode toggle
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    toggleDarkMode();
                }
                
                // ? for keyboard shortcuts modal
                if (e.key === '?') {
                    e.preventDefault();
                    toggleKeyboardShortcutsModal(true);
                }
                
                // Escape key to close modals
                if (e.key === 'Escape') {
                    const activeModals = document.querySelectorAll('.fixed.inset-0:not(.hidden)');
                    if (activeModals.length > 0) {
                        e.preventDefault();
                        activeModals.forEach(modal => {
                            toggleElement(modal, false);
                        });
                    }
                }
            });
            
            // Setup keyboard shortcuts modal
            const keyboardShortcutsModal = document.getElementById('keyboard-shortcuts-modal');
            const closeShortcutsModal = document.getElementById('close-shortcuts-modal');
            const closeShortcutsButton = document.getElementById('close-shortcuts-button');
            
            if (closeShortcutsModal) {
                closeShortcutsModal.addEventListener('click', () => toggleKeyboardShortcutsModal(false));
            }
            
            if (closeShortcutsButton) {
                closeShortcutsButton.addEventListener('click', () => toggleKeyboardShortcutsModal(false));
            }
        }
        
        // Toggle Keyboard Shortcuts Modal
        function toggleKeyboardShortcutsModal(show) {
            const keyboardShortcutsModal = document.getElementById('keyboard-shortcuts-modal');
            toggleElement(keyboardShortcutsModal, show);
        }
        
        // Toggle Search Modal
        function toggleSearchModal(show) {
            const searchModal = document.getElementById('search-modal');
            toggleElement(searchModal, show);
            
            if (show) {
                // Focus search input
                setTimeout(() => {
                    const searchInput = document.getElementById('global-search');
                    if (searchInput) searchInput.focus();
                }, 100);
            }
            
            // Setup search modal events
            const closeSearchModal = document.getElementById('close-search-modal');
            const searchCancel = document.getElementById('search-cancel');
            
            if (closeSearchModal) {
                closeSearchModal.addEventListener('click', () => toggleSearchModal(false));
            }
            
            if (searchCancel) {
                searchCancel.addEventListener('click', () => toggleSearchModal(false));
            }
        }
        
        // Toggle Left Drawer
        function toggleDrawer(show) {
            const drawer = document.getElementById('left-drawer');
            const backdrop = document.getElementById('drawer-backdrop');
            
            if (!drawer || !backdrop) return;
            
            if (show === undefined) {
                show = drawer.classList.contains('-translate-x-full');
            }
            
            if (show) {
                drawer.classList.remove('-translate-x-full');
                backdrop.classList.remove('hidden');
            } else {
                drawer.classList.add('-translate-x-full');
                backdrop.classList.add('hidden');
            }
        }
        
        // Show Specific Page
        function showPage(page) {
            state.currentPage = page;
            
            // Update page title and subtitle
            const pageTitle = document.getElementById('page-title');
            const pageSubtitle = document.getElementById('page-subtitle');
            
            if (pageTitle && pageSubtitle) {
                switch (page) {
                    case 'dashboard':
                        pageTitle.textContent = 'Dashboard';
                        pageSubtitle.textContent = 'Visão geral do desempenho da safra 2025';
                        break;
                    case 'entrega-hora':
                        pageTitle.textContent = 'Entrega por Hora';
                        pageSubtitle.textContent = 'Gerencie o registro de entregas por período';
                        break;
                    case 'relatorios':
                        pageTitle.textContent = 'Análises e Relatórios';
                        pageSubtitle.textContent = 'Relatórios detalhados e análises de desempenho';
                        break;
                    case 'historico':
                        pageTitle.textContent = 'Histórico de Registros';
                        pageSubtitle.textContent = 'Visualize e compare dados de diferentes datas';
                        break;
                    case 'metas':
                        pageTitle.textContent = 'Metas e Desempenho';
                        pageSubtitle.textContent = 'Acompanhe o progresso das metas estabelecidas';
                        break;
                    case 'configuracoes':
                        pageTitle.textContent = 'Configurações';
                        pageSubtitle.textContent = 'Ajuste as configurações do sistema';
                        break;
                    default:
                        pageTitle.textContent = 'Dashboard';
                        pageSubtitle.textContent = 'Visão geral do desempenho da safra 2025';
                }
            }
            
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show selected page
            const pageContent = document.getElementById(`${page}-content`);
            if (pageContent) {
                pageContent.classList.remove('hidden');
                
                // If showing the entrega-hora page, generate the time period HTML
                if (page === 'entrega-hora') {
                    generateTimePeriodHTML();
                }
                
                // If showing the dashboard, update the dashboard with current data
                if (page === 'dashboard') {
                    updateDashboardCharts();
                    updateEmptyStateVisibility();
                }
                
                // If showing the history page, update the available dates
                if (page === 'historico') {
                    updateAvailableDates();
                    initializeHistoryCharts();
                }
                
                // If showing the reports page, setup date selector
                if (page === 'relatorios') {
                    setupDateSelector();
                    hideReportContent();
                }
            } else {
                // If page doesn't exist, show dashboard
                const dashboardContent = document.getElementById('dashboard-content');
                if (dashboardContent) dashboardContent.classList.remove('hidden');
            }
            
            // Update navigation active state
            document.querySelectorAll('.drawer-link').forEach(link => {
                link.classList.remove('bg-primary', 'text-white');
                link.classList.add('text-gray-700', 'dark:text-gray-300');
                
                if (link.getAttribute('data-page') === page) {
                    link.classList.add('bg-primary', 'text-white');
                    link.classList.remove('text-gray-700', 'dark:text-gray-300');
                }
            });
        }

        // Check if there's any user data and update empty state visibility
        function updateEmptyStateVisibility() {
            const dashboardEmptyState = document.getElementById('dashboard-empty-state');
            if (!dashboardEmptyState) return;

            // Check if there's any data
            let hasAnyData = false;

            // Check for density, trips, or potential values
            for (const front in state.density) {
                for (const hour in state.density[front]) {
                    if (state.density[front][hour] > 0 || state.trips[front][hour] > 0 || state.potential[front][hour] > 0) {
                        hasAnyData = true;
                        break;
                    }
                }
                if (hasAnyData) break;
            }

            // Update state
            state.hasData = hasAnyData;

            // Show/hide empty state
            if (state.hasData) {
                dashboardEmptyState.classList.add('hidden');
            } else {
                dashboardEmptyState.classList.remove('hidden');
            }
        }
        
        // Generate Time Period HTML
        function generateTimePeriodHTML() {
            showLoading(true);
            
            const timeContentDiv = document.getElementById('time-period-content');
            if (!timeContentDiv) {
                showLoading(false);
                return;
            }
            
            timeContentDiv.innerHTML = '';
            
            // Show history mode indicator if in history mode
            const dateSelectorContainer = document.getElementById('date-selector-container');
            const historyModeIndicator = document.getElementById('history-mode-indicator');
            const headerSelectedDate = document.getElementById('header-selected-date');
            const exitHistoryModeButton = document.getElementById('exit-history-mode');
            
            if (state.historyCompareMode) {
                // Display date selector when in history mode
                if (dateSelectorContainer) {
                    dateSelectorContainer.classList.remove('hidden');
                    
                    // Update current historical date
                    const currentHistoricalDate = document.getElementById('current-historical-date');
                    if (currentHistoricalDate) {
                        currentHistoricalDate.textContent = formatDate(state.calendar.selectedDate);
                    }
                }
                
                // Show history mode indicator
                if (historyModeIndicator) historyModeIndicator.classList.remove('hidden');
                
                // Show selected date in header
                if (headerSelectedDate) {
                    headerSelectedDate.classList.remove('hidden');
                    headerSelectedDate.classList.add('flex');
                    
                    const selectedDateText = document.getElementById('selected-date-text');
                    if (selectedDateText) {
                        selectedDateText.textContent = formatDate(state.calendar.selectedDate);
                    }
                }
                
                // Show exit history mode button
                if (exitHistoryModeButton) {
                    exitHistoryModeButton.classList.remove('hidden');
                    exitHistoryModeButton.classList.add('flex');
                }
            } else {
                // Hide history mode UI elements when not in history mode
                if (dateSelectorContainer) dateSelectorContainer.classList.add('hidden');
                if (historyModeIndicator) historyModeIndicator.classList.add('hidden');
                if (headerSelectedDate) {
                    headerSelectedDate.classList.remove('flex');
                    headerSelectedDate.classList.add('hidden');
                }
                if (exitHistoryModeButton) {
                    exitHistoryModeButton.classList.remove('flex');
                    exitHistoryModeButton.classList.add('hidden');
                }
            }
            
            for (const period in state.timePeriodsMap) {
                const hours = state.timePeriodsMap[period];
                
                const periodDiv = document.createElement('div');
                periodDiv.id = `period-${period}`;
                periodDiv.className = 'period-content' + (period === state.activePeriod ? '' : ' hidden');
                
                let periodHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">`;
                
                for (const hour of hours) {
                    let hasPotencial = hour % 2 !== 0; // Only odd hours have potential
                    
                    periodHTML += `
                    <div class="overflow-hidden rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                        <div class="bg-gray-100 dark:bg-gray-700 py-2 px-4 flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-primary dark:text-primary-300 flex items-center">
                                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                ${hour.toString().padStart(2, '0')}:00
                            </h3>
                            <div class="flex items-center text-sm">
                                <span class="text-gray-600 dark:text-gray-400 flex items-center mr-3">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
                                    </svg>
                                    <span class="total-viagens-badge" data-hour="${hour}">0</span> viagens
                                </span>
                                <span class="text-primary dark:text-primary-300 flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                                    </svg>
                                    <span class="total-entrega-badge" data-hour="${hour}">0.00</span> ton
                                </span>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-800">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Frentes</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Densid.</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Viagens</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Entrega</th>
                                        ${hasPotencial ? '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Pot. Hora</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">`;
                    
                    for (const front of state.fronts) {
                        periodHTML += `
                                    <tr>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <span class="font-medium">${front}</span>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <input type="number" class="input-number densidade w-20 text-right border rounded px-2 py-1 dark:bg-gray-700" data-hour="${hour}" data-front="${front}" value="${state.density[front][hour]}" min="0" step="0.01">
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <input type="number" class="input-number viagens w-20 text-right border rounded px-2 py-1 dark:bg-gray-700" data-hour="${hour}" data-front="${front}" value="${state.trips[front][hour]}" min="0">
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <span class="entrega font-medium ${state.delivery[front][hour] > 0 ? 'text-success-600 dark:text-success-400' : ''}" data-hour="${hour}" data-front="${front}">${state.delivery[front][hour].toFixed(2)}</span>
                                        </td>
                                        ${hasPotencial ? `<td class="px-4 py-3 whitespace-nowrap">
                                            <input type="number" class="input-number potencial w-20 text-right border rounded px-2 py-1 dark:bg-gray-700" data-hour="${hour}" data-front="${front}" value="${state.potential[front][hour]}" min="0">
                                        </td>` : ''}
                                    </tr>`;
                    }
                    
                    periodHTML += `
                                </tbody>
                                <tfoot class="bg-gray-50 dark:bg-gray-700 font-semibold">
                                    <tr>
                                        <td class="px-4 py-3 whitespace-nowrap">TOTAL</td>
                                        <td class="px-4 py-3 whitespace-nowrap"></td>
                                        <td class="px-4 py-3 whitespace-nowrap total-viagens" data-hour="${hour}">0</td>
                                        <td class="px-4 py-3 whitespace-nowrap total-entrega" data-hour="${hour}">0.00</td>
                                        ${hasPotencial ? `<td class="px-4 py-3 whitespace-nowrap total-potencial" data-hour="${hour}">0</td>` : ''}
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>`;
                }
                
                periodHTML += `
                </div>

                <!-- Period Summary -->
                <div class="mt-6 overflow-hidden rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="bg-gray-100 dark:bg-gray-700 py-2 px-4">
                        <h3 class="text-lg font-semibold text-primary dark:text-primary-300 flex items-center">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            RESUMO DO PERÍODO (${period.substring(0, 2)}:00-${period.substring(3, 5)}:00)
                        </h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-800">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Frentes</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">2 Horas</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Potencial 2H</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Diferença</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">% Realizado</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">`;
                
                for (const front of state.fronts) {
                    periodHTML += `
                                <tr>
                                    <td class="px-4 py-3 whitespace-nowrap font-medium">F${front}</td>
                                    <td class="px-4 py-3 whitespace-nowrap duas-horas" data-period="${period}" data-front="${front}">0.00</td>
                                    <td class="px-4 py-3 whitespace-nowrap potencial-2h" data-period="${period}" data-front="${front}">0</td>
                                    <td class="px-4 py-3 whitespace-nowrap diff" data-period="${period}" data-front="${front}">0.00</td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2.5 relative overflow-hidden">
                                            <div class="percent-bar bg-primary h-2.5 rounded-full" data-period="${period}" data-front="${front}" style="width: 0%"></div>
                                        </div>
                                        <span class="text-xs mt-1 block text-right percent-text" data-period="${period}" data-front="${front}">0%</span>
                                    </td>
                                </tr>`;
                }
                
                periodHTML += `
                            </tbody>
                            <tfoot class="bg-gray-50 dark:bg-gray-700 font-semibold">
                                <tr>
                                    <td class="px-4 py-3 whitespace-nowrap">TOTAL</td>
                                    <td class="px-4 py-3 whitespace-nowrap total-duas-horas" data-period="${period}">0.00</td>
                                    <td class="px-4 py-3 whitespace-nowrap total-potencial-2h" data-period="${period}">0</td>
                                    <td class="px-4 py-3 whitespace-nowrap total-diff" data-period="${period}">0.00</td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2.5 relative overflow-hidden">
                                            <div class="total-percent-bar bg-primary h-2.5 rounded-full" data-period="${period}" style="width: 0%"></div>
                                        </div>
                                        <span class="text-xs mt-1 block text-right total-percent-text" data-period="${period}">0%</span>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>`;
                
                periodDiv.innerHTML = periodHTML;
                timeContentDiv.appendChild(periodDiv);
            }
            
            // Add event listeners to newly generated elements
            setupDynamicEventListeners();
            
            // Update the UI with current data
            updateUI();
            
            showLoading(false);
        }
        
        // Setup event listeners for dynamically generated elements
        function setupDynamicEventListeners() {
            // Input changes for delivery data
            document.querySelectorAll('.densidade, .viagens, .potencial').forEach(input => {
                input.addEventListener('input', handleDeliveryDataChange);
                
                // Disable inputs if in history mode
                if (state.historyCompareMode) {
                    input.disabled = true;
                }
                
                // Add number input controls
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        const step = this.classList.contains('densidade') ? 0.01 : 1;
                        this.value = (parseFloat(this.value) + step).toFixed(this.classList.contains('densidade') ? 2 : 0);
                        this.dispatchEvent(new Event('input'));
                    } else if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        const step = this.classList.contains('densidade') ? 0.01 : 1;
                        const newValue = Math.max(0, parseFloat(this.value) - step);
                        this.value = newValue.toFixed(this.classList.contains('densidade') ? 2 : 0);
                        this.dispatchEvent(new Event('input'));
                    }
                });
            });
        }
        
        // Show/hide loading indicator
        function showLoading(show) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const timeContentDiv = document.getElementById('time-period-content');
            
            if (loadingIndicator && timeContentDiv) {
                if (show) {
                    loadingIndicator.classList.remove('hidden');
                    timeContentDiv.classList.add('hidden');
                } else {
                    loadingIndicator.classList.add('hidden');
                    timeContentDiv.classList.remove('hidden');
                }
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Menu button for drawer
            document.getElementById('menu-button')?.addEventListener('click', toggleDrawer);
            
            // Drawer backdrop click to close
            document.getElementById('drawer-backdrop')?.addEventListener('click', () => toggleDrawer(false));
            
            // Search button
            document.getElementById('search-button')?.addEventListener('click', () => toggleSearchModal(true));
            
            // Main tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', switchMainTab);
            });
            
            // Time period tab switching
            document.querySelectorAll('.time-tab-btn').forEach(button => {
                button.addEventListener('click', switchTimePeriodTab);
            });
            
            // Save button
            document.getElementById('save-data')?.addEventListener('click', function() {
                // Don't allow saving in history mode
                if (state.historyCompareMode) {
                    showToast('Não é possível salvar enquanto estiver visualizando dados históricos. Saia do modo histórico primeiro.', 'warning');
                    return;
                }
                
                saveData();
                showToast('Dados salvos com sucesso!', 'success');
            });
            
            // Clear period button
            document.getElementById('clear-period')?.addEventListener('click', function() {
                // Don't allow clearing in history mode
                if (state.historyCompareMode) {
                    showToast('Não é possível limpar dados enquanto estiver visualizando dados históricos. Saia do modo histórico primeiro.', 'warning');
                    return;
                }
                
                showConfirmationModal(
                    'Limpar Período',
                    `Tem certeza que deseja limpar todos os dados do período ${state.activePeriod}?`,
                    clearCurrentPeriod
                );
            });
            
            // Copy previous period button
            document.getElementById('copy-previous')?.addEventListener('click', function() {
                // Don't allow copying in history mode
                if (state.historyCompareMode) {
                    showToast('Não é possível copiar dados enquanto estiver visualizando dados históricos. Saia do modo histórico primeiro.', 'warning');
                    return;
                }
                
                copyPreviousPeriod();
            });
            
            // Export buttons
            document.getElementById('export-json')?.addEventListener('click', exportJSON);
            document.getElementById('export-csv')?.addEventListener('click', exportCSV);
            document.getElementById('export-pdf')?.addEventListener('click', exportPDF);
            document.getElementById('export-dashboard')?.addEventListener('click', exportDashboard);
            
            // Modal buttons
            document.getElementById('modal-cancel')?.addEventListener('click', closeConfirmationModal);
        }
        
        // Tab Switching Functions
        function switchMainTab(e) {
            const tabId = e.target.closest('.tab-button').getAttribute('data-tab');
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'text-primary', 'border-primary');
                button.classList.add('text-secondary-500', 'dark:text-secondary-400', 'border-transparent');
            });
            
            e.target.closest('.tab-button').classList.add('active', 'text-primary', 'border-primary');
            e.target.closest('.tab-button').classList.remove('text-secondary-500', 'dark:text-secondary-400', 'border-transparent');
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show selected tab content
            document.getElementById(`${tabId}-content`).classList.remove('hidden');
        }
        
        function switchTimePeriodTab(e) {
            const period = e.target.getAttribute('data-period');
            state.activePeriod = period;
            
            // Update time tab buttons
            document.querySelectorAll('.time-tab-btn').forEach(button => {
                button.classList.remove('bg-primary', 'text-white');
                button.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
            });
            
            e.target.classList.add('bg-primary', 'text-white');
            e.target.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
            
            // Hide all period contents
            document.querySelectorAll('.period-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show selected period content
            document.getElementById(`period-${period}`)?.classList.remove('hidden');
        }
        
        // Data Calculation Functions
        function calculateDelivery() {
            for (const front of state.fronts) {
                for (const hour of state.hours) {
                    state.delivery[front][hour] = state.density[front][hour] * state.trips[front][hour];
                }
            }
        }
        
        function calculateTwoHourTotals() {
            for (const period in state.timePeriodsMap) {
                const hours = state.timePeriodsMap[period];
                
                for (const front of state.fronts) {
                    // Calculate two-hour delivery total
                    state.twoHourDelivery[period][front] = hours.reduce((sum, hour) => {
                        return sum + state.delivery[front][hour];
                    }, 0);
                    
                    // Calculate two-hour potential (use the odd hour's potential * 2)
                    const oddHour = hours.find(h => h % 2 !== 0) || hours[0];
                    state.twoHourPotential[period][front] = state.potential[front][oddHour] * 2;
                    
                    // Calculate difference
                    state.difference[period][front] = 
                        state.twoHourDelivery[period][front] - state.twoHourPotential[period][front];
                }
            }
        }
        
        // Data Handling Functions
        function handleDeliveryDataChange(e) {
            // Don't process changes if in history mode
            if (state.historyCompareMode) return;
            
            const hour = parseInt(e.target.getAttribute('data-hour'));
            const front = e.target.getAttribute('data-front');
            const value = parseFloat(e.target.value) || 0;
            
            if (e.target.classList.contains('densidade')) {
                state.density[front][hour] = value;
            } else if (e.target.classList.contains('viagens')) {
                state.trips[front][hour] = value;
            } else if (e.target.classList.contains('potencial')) {
                state.potential[front][hour] = value;
            }
            
            calculateDelivery();
            calculateTwoHourTotals();
            updateUI();
            
            // Add to history for undo/redo functionality
            addToHistory('data-change', { hour, front, field: e.target.classList[1], value });
            
            // Update the hasData flag
            state.hasData = true;
            
            // Update dashboard empty state if needed
            if (state.currentPage === 'dashboard') {
                updateEmptyStateVisibility();
            }
        }
        
        // Add action to history
        function addToHistory(action, data) {
            state.history.push({ action, data, timestamp: new Date() });
            
            // Limit history size to prevent memory issues
            if (state.history.length > 100) {
                state.history.shift();
            }
        }
        
        function clearCurrentPeriod() {
            const hours = state.timePeriodsMap[state.activePeriod];
            
            for (const front of state.fronts) {
                for (const hour of hours) {
                    state.density[front][hour] = 0;
                    state.trips[front][hour] = 0;
                    state.delivery[front][hour] = 0;
                    
                    // Reset potential only for odd hours
                    if (hour % 2 !== 0) {
                        state.potential[front][hour] = 0;
                    }
                }
            }
            
            calculateDelivery();
            calculateTwoHourTotals();
            generateTimePeriodHTML();
            updateUI();
            showToast(`Período ${state.activePeriod} limpo com sucesso`, 'success');
            
            // Add to history
            addToHistory('clear-period', { period: state.activePeriod });
        }
        
        function copyPreviousPeriod() {
            const periods = Object.keys(state.timePeriodsMap);
            const currentIndex = periods.indexOf(state.activePeriod);
            
            if (currentIndex <= 0) {
                showToast('Não há período anterior para copiar', 'error');
                return;
            }
            
            const previousPeriod = periods[currentIndex - 1];
            const previousHours = state.timePeriodsMap[previousPeriod];
            const currentHours = state.timePeriodsMap[state.activePeriod];
            
            // Copy data from previous period
            for (let i = 0; i < currentHours.length; i++) {
                const currentHour = currentHours[i];
                const previousHour = previousHours[i];
                
                for (const front of state.fronts) {
                    state.density[front][currentHour] = state.density[front][previousHour];
                    state.trips[front][currentHour] = state.trips[front][previousHour];
                    
                    // For odd hours, also copy potential
                    if (currentHour % 2 !== 0) {
                        state.potential[front][currentHour] = state.potential[front][previousHour];
                    }
                }
            }
            
            calculateDelivery();
            calculateTwoHourTotals();
            generateTimePeriodHTML();
            updateUI();
            showToast(`Dados copiados do período ${previousPeriod} para ${state.activePeriod}`, 'success');
            
            // Add to history
            addToHistory('copy-period', { from: previousPeriod, to: state.activePeriod });
        }
        
        // UI Update Functions
        function updateUI() {
            updateDeliveryUI();
            updateCharts();
        }
        
        function updateDeliveryUI() {
            // Update delivery values for all hours
            document.querySelectorAll('.entrega').forEach(element => {
                const hour = parseInt(element.getAttribute('data-hour'));
                const front = element.getAttribute('data-front');
                const value = state.delivery[front][hour];
                element.textContent = value.toFixed(2);
                
                // Add color based on value
                element.classList.remove('text-success-600', 'dark:text-success-400', 'text-danger-600', 'dark:text-danger-400');
                if (value > 0) {
                    element.classList.add('text-success-600', 'dark:text-success-400');
                }
            });
            
            // Update total trips and delivery per hour
            for (const hour of state.hours) {
                const totalTripsElement = document.querySelector(`.total-viagens[data-hour="${hour}"]`);
                const totalDeliveryElement = document.querySelector(`.total-entrega[data-hour="${hour}"]`);
                const totalPotentialElement = document.querySelector(`.total-potencial[data-hour="${hour}"]`);
                
                const totalTripsBadge = document.querySelector(`.total-viagens-badge[data-hour="${hour}"]`);
                const totalEntregaBadge = document.querySelector(`.total-entrega-badge[data-hour="${hour}"]`);
                
                if (totalTripsElement || totalTripsBadge) {
                    const totalTrips = state.fronts.reduce((sum, front) => sum + state.trips[front][hour], 0);
                    
                    if (totalTripsElement) totalTripsElement.textContent = totalTrips;
                    if (totalTripsBadge) totalTripsBadge.textContent = totalTrips;
                }
                
                if (totalDeliveryElement || totalEntregaBadge) {
                    const totalDelivery = state.fronts.reduce((sum, front) => sum + state.delivery[front][hour], 0);
                    
                    if (totalDeliveryElement) totalDeliveryElement.textContent = totalDelivery.toFixed(2);
                    if (totalEntregaBadge) totalEntregaBadge.textContent = totalDelivery.toFixed(2);
                }
                
                if (totalPotentialElement && hour % 2 !== 0) { // Only odd hours have potential
                    const totalPotential = state.fronts.reduce((sum, front) => sum + state.potential[front][hour], 0);
                    totalPotentialElement.textContent = totalPotential;
                }
            }
            
            // Update two-hour summaries for all periods
            for (const period in state.timePeriodsMap) {
                for (const front of state.fronts) {
                    const duasHorasElement = document.querySelector(`.duas-horas[data-period="${period}"][data-front="${front}"]`);
                    const potencial2hElement = document.querySelector(`.potencial-2h[data-period="${period}"][data-front="${front}"]`);
                    const diffElement = document.querySelector(`.diff[data-period="${period}"][data-front="${front}"]`);
                    const percentBar = document.querySelector(`.percent-bar[data-period="${period}"][data-front="${front}"]`);
                    const percentText = document.querySelector(`.percent-text[data-period="${period}"][data-front="${front}"]`);
                    
                    if (duasHorasElement && potencial2hElement && diffElement) {
                        duasHorasElement.textContent = state.twoHourDelivery[period][front].toFixed(2);
                        potencial2hElement.textContent = state.twoHourPotential[period][front];
                        diffElement.textContent = state.difference[period][front].toFixed(2);
                        
                        // Color-code differences
                        diffElement.classList.remove('text-red-600', 'dark:text-red-400', 'text-green-600', 'dark:text-green-400');
                        if (state.difference[period][front] < 0) {
                            diffElement.classList.add('text-red-600', 'dark:text-red-400');
                        } else if (state.difference[period][front] > 0) {
                            diffElement.classList.add('text-green-600', 'dark:text-green-400');
                        }
                        
                        // Update percentage bar
                        if (percentBar && percentText) {
                            const potential = state.twoHourPotential[period][front];
                            const actual = state.twoHourDelivery[period][front];
                            
                            let percentage = potential > 0 ? (actual / potential) * 100 : 0;
                            percentage = Math.min(percentage, 100); // Cap at 100%
                            
                            percentBar.style.width = `${percentage}%`;
                            percentText.textContent = `${percentage.toFixed(1)}%`;
                            
                            // Color the bar based on percentage
                            percentBar.classList.remove('bg-primary', 'bg-green-500', 'bg-yellow-500', 'bg-red-500');
                            
                            if (percentage >= 90) {
                                percentBar.classList.add('bg-green-500');
                            } else if (percentage >= 75) {
                                percentBar.classList.add('bg-primary');
                            } else if (percentage >= 50) {
                                percentBar.classList.add('bg-yellow-500');
                            } else {
                                percentBar.classList.add('bg-red-500');
                            }
                        }
                    }
                }
                
                // Update two-hour totals
                const totalDuasHorasElement = document.querySelector(`.total-duas-horas[data-period="${period}"]`);
                const totalPotencial2hElement = document.querySelector(`.total-potencial-2h[data-period="${period}"]`);
                const totalDiffElement = document.querySelector(`.total-diff[data-period="${period}"]`);
                const totalPercentBar = document.querySelector(`.total-percent-bar[data-period="${period}"]`);
                const totalPercentText = document.querySelector(`.total-percent-text[data-period="${period}"]`);
                
                if (totalDuasHorasElement && totalPotencial2hElement && totalDiffElement) {
                    const totalDuasHoras = state.fronts.reduce(
                        (sum, front) => sum + state.twoHourDelivery[period][front], 0
                    );
                    const totalPotencial2h = state.fronts.reduce(
                        (sum, front) => sum + state.twoHourPotential[period][front], 0
                    );
                    const totalDiff = state.fronts.reduce(
                        (sum, front) => sum + state.difference[period][front], 0
                    );
                    
                    totalDuasHorasElement.textContent = totalDuasHoras.toFixed(2);
                    totalPotencial2hElement.textContent = totalPotencial2h;
                    totalDiffElement.textContent = totalDiff.toFixed(2);
                    
                    // Color-code total difference
                    totalDiffElement.classList.remove('text-red-600', 'dark:text-red-400', 'text-green-600', 'dark:text-green-400');
                    if (totalDiff < 0) {
                        totalDiffElement.classList.add('text-red-600', 'dark:text-red-400');
                    } else if (totalDiff > 0) {
                        totalDiffElement.classList.add('text-green-600', 'dark:text-green-400');
                    }
                    
                    // Update total percentage bar
                    if (totalPercentBar && totalPercentText) {
                        let percentage = totalPotencial2h > 0 ? (totalDuasHoras / totalPotencial2h) * 100 : 0;
                        percentage = Math.min(percentage, 100); // Cap at 100%
                        
                        totalPercentBar.style.width = `${percentage}%`;
                        totalPercentText.textContent = `${percentage.toFixed(1)}%`;
                        
                        // Color the bar based on percentage
                        totalPercentBar.classList.remove('bg-primary', 'bg-green-500', 'bg-yellow-500', 'bg-red-500');
                        
                        if (percentage >= 90) {
                            totalPercentBar.classList.add('bg-green-500');
                        } else if (percentage >= 75) {
                            totalPercentBar.classList.add('bg-primary');
                        } else if (percentage >= 50) {
                            totalPercentBar.classList.add('bg-yellow-500');
                        } else {
                            totalPercentBar.classList.add('bg-red-500');
                        }
                    }
                }
            }
        }
        
        // Chart Functions
        function initializeCharts() {
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded. Charts will not be initialized.');
                return;
            }
            
            // Check if the ChartDataLabels plugin is loaded
            if (typeof ChartDataLabels === 'undefined') {
                console.warn('ChartDataLabels plugin is not loaded. Charts will not have data labels.');
            } else {
                // Register Chart.js plugins
                Chart.register(ChartDataLabels);
            }
            
            // Front Summary Chart
            const frontSummaryCtx = document.getElementById('frontSummaryChart')?.getContext('2d');
            if (frontSummaryCtx) {
                state.charts.frontSummary = new Chart(frontSummaryCtx, {
                    type: 'bar',
                    data: {
                        labels: state.fronts.map(front => `F${front}`),
                        datasets: [{
                            label: 'Entregas (toneladas)',
                            data: Array(state.fronts.length).fill(0),
                            backgroundColor: 'rgba(93, 92, 222, 0.7)',
                            borderColor: 'rgba(93, 92, 222, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Toneladas'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.raw.toFixed(2)} ton`;
                                    }
                                }
                            },
                            legend: {
                                position: 'top'
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => value.toFixed(1) + ' t',
                                color: function(context) {
                                    return document.documentElement.classList.contains('dark') 
                                        ? '#E5E7EB' : '#374151';
                                },
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                });
            }
            
            // Hourly Performance Chart
            const hourlyPerformanceCtx = document.getElementById('hourlyPerformanceChart')?.getContext('2d');
            if (hourlyPerformanceCtx) {
                state.charts.hourlyPerformance = new Chart(hourlyPerformanceCtx, {
                    type: 'line',
                    data: {
                        labels: state.hours.slice(0, 12).map(hour => `${hour.toString().padStart(2, '0')}:00`),
                        datasets: [
                            {
                                label: 'Entregas',
                                data: Array(12).fill(0),
                                backgroundColor: 'rgba(93, 92, 222, 0.2)',
                                borderColor: 'rgba(93, 92, 222, 1)',
                                borderWidth: 2,
                                tension: 0.4
                            },
                            {
                                label: 'Potencial',
                                data: Array(12).fill(0),
                                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                                borderColor: 'rgba(16, 185, 129, 1)',
                                borderWidth: 2,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Toneladas'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Horário'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.raw.toFixed(2)} ton`;
                                    }
                                }
                            },
                            legend: {
                                position: 'top'
                            },
                            datalabels: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            // Efficiency Gauge Chart (Using horizontal bar chart as a gauge)
            const efficiencyGaugeCtx = document.getElementById('efficiencyGaugeChart')?.getContext('2d');
            if (efficiencyGaugeCtx) {
                state.charts.efficiencyGauge = new Chart(efficiencyGaugeCtx, {
                    type: 'bar',
                    data: {
                        labels: state.fronts.map(front => `F${front}`),
                        datasets: [{
                            label: 'Eficiência (%)',
                            data: Array(state.fronts.length).fill(0),
                            backgroundColor: state.fronts.map(() => getEfficiencyColor(0)),
                            borderColor: state.fronts.map(() => getEfficiencyColor(0, true)),
                            borderWidth: 1,
                            barPercentage: 0.8,
                            categoryPercentage: 0.8
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Porcentagem (%)'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Eficiência: ${context.raw.toFixed(1)}%`;
                                    }
                                }
                            },
                            legend: {
                                display: false
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'end',
                                formatter: (value) => value.toFixed(1) + '%',
                                color: function(context) {
                                    return document.documentElement.classList.contains('dark') 
                                        ? '#E5E7EB' : '#374151';
                                },
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                });
                
                // Use custom function to update efficiency colors
                updateEfficiencyColors(state.charts.efficiencyGauge);
            }
            
            // Delivery by Period Chart for Dashboard
            const deliveryByPeriodCtx = document.getElementById('deliveryByPeriodChart')?.getContext('2d');
            if (deliveryByPeriodCtx) {
                state.charts.deliveryByPeriod = new Chart(deliveryByPeriodCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Entregas',
                                data: [],
                                backgroundColor: 'rgba(93, 92, 222, 0.7)',
                                borderColor: 'rgba(93, 92, 222, 1)',
                                borderWidth: 1,
                                barPercentage: 0.7,
                                categoryPercentage: 0.9,
                                order: 2
                            },
                            {
                                label: 'Potencial',
                                data: [],
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderColor: 'rgba(16, 185, 129, 1)',
                                borderWidth: 1,
                                borderDash: [5, 5],
                                type: 'line',
                                fill: false,
                                pointStyle: 'rectRounded',
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                tension: 0.4,
                                order: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Toneladas'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Períodos'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.raw.toFixed(2)} ton`;
                                    }
                                }
                            },
                            legend: {
                                position: 'top'
                            },
                            datalabels: {
                                display: function(context) {
                                    // Only show data labels for the bar dataset
                                    return context.datasetIndex === 0;
                                },
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => value.toFixed(0) + ' t',
                                color: function(context) {
                                    return document.documentElement.classList.contains('dark') 
                                        ? '#E5E7EB' : '#374151';
                                },
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                });
            }
            
            // Front Performance Chart for Dashboard
            const frontPerformanceCtx = document.getElementById('frontPerformanceChart')?.getContext('2d');
            if (frontPerformanceCtx) {
                state.charts.frontPerformance = new Chart(frontPerformanceCtx, {
                    type: 'bar',
                    data: {
                        labels: state.fronts.map(front => `F${front}`),
                        datasets: [
                            {
                                label: 'Eficiência (%)',
                                data: Array(state.fronts.length).fill(0),
                                backgroundColor: Array(state.fronts.length).fill(getEfficiencyColorGradient(0)),
                                borderWidth: 0,
                                borderRadius: 4,
                                barPercentage: 0.6,
                                categoryPercentage: 0.8
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Eficiência (%)'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Eficiência: ${context.raw.toFixed(1)}%`;
                                    }
                                }
                            },
                            legend: {
                                display: false
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => value.toFixed(1) + '%',
                                color: function(context) {
                                    return document.documentElement.classList.contains('dark') 
                                        ? '#E5E7EB' : '#374151';
                                },
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                });
            }
            
            // 24-Hour Production Chart
            const production24HoursCtx = document.getElementById('production24HoursChart')?.getContext('2d');
            if (production24HoursCtx) {
                state.charts.production24HoursChart = new Chart(production24HoursCtx, {
                    type: 'line',
                    data: {
                        labels: state.hours.map(hour => `${hour.toString().padStart(2, '0')}:00`),
                        datasets: state.fronts.map((front, index) => ({
                            label: `Frente ${front}`,
                            data: Array(24).fill(0),
                            borderColor: getColorForFront(index),
                            backgroundColor: getColorForFront(index, 0.1),
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false,
                            pointStyle: 'circle',
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Produção (toneladas)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Hora do Dia'
                                },
                                grid: {
                                    display: true,
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.raw.toFixed(2)} ton`;
                                    }
                                }
                            },
                            legend: {
                                position: 'top'
                            },
                            datalabels: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            // Trips by Front Chart
            const tripsByFrontCtx = document.getElementById('tripsByFrontChart')?.getContext('2d');
            if (tripsByFrontCtx) {
                state.charts.tripsByFront = new Chart(tripsByFrontCtx, {
                    type: 'bar',
                    data: {
                        labels: state.fronts.map(front => `Frente ${front}`),
                        datasets: [{
                            label: 'Total de Viagens',
                            data: Array(state.fronts.length).fill(0),
                            backgroundColor: 'rgba(52, 211, 153, 0.7)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                            barPercentage: 0.6,
                            categoryPercentage: 0.8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Número de Viagens'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Total de Viagens: ${context.raw}`;
                                    }
                                }
                            },
                            legend: {
                                display: false
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => value,
                                color: function(context) {
                                    return document.documentElement.classList.contains('dark') 
                                        ? '#E5E7EB' : '#374151';
                                },
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                });
            }
            
            // Trucks per Hour Chart
            const trucksPerHourCtx = document.getElementById('trucksPerHourChart')?.getContext('2d');
            if (trucksPerHourCtx) {
                state.charts.trucksPerHour = new Chart(trucksPerHourCtx, {
                    type: 'bar',
                    data: {
                        labels: state.fronts.map(front => `Frente ${front}`),
                        datasets: [{
                            label: 'Caminhões por Hora',
                            data: Array(state.fronts.length).fill(0),
                            backgroundColor: 'rgba(139, 92, 246, 0.7)',
                            borderColor: 'rgba(124, 58, 237, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                            barPercentage: 0.6,
                            categoryPercentage: 0.8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Média de Caminhões/Hora'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Média: ${context.raw.toFixed(1)} caminhões/hora`;
                                    }
                                }
                            },
                            legend: {
                                display: false
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => value.toFixed(1),
                                color: function(context) {
                                    return document.documentElement.classList.contains('dark') 
                                        ? '#E5E7EB' : '#374151';
                                },
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                });
            }
            
            // Update all charts with current data
            updateCharts();
        }
        
        // Helper function to get color for each front
        function getColorForFront(index, alpha = 1) {
            const colors = [
                `rgba(93, 92, 222, ${alpha})`,   // Primary blue-purple
                `rgba(16, 185, 129, ${alpha})`,  // Green
                `rgba(245, 158, 11, ${alpha})`,  // Amber
                `rgba(239, 68, 68, ${alpha})`,   // Red
                `rgba(139, 92, 246, ${alpha})`,  // Purple
                `rgba(59, 130, 246, ${alpha})`,  // Blue
                `rgba(236, 72, 153, ${alpha})`,  // Pink
                `rgba(251, 146, 60, ${alpha})`   // Orange
            ];
            
            return colors[index % colors.length];
        }
        
        // Get color based on efficiency value
        function getEfficiencyColor(value, isBorder = false) {
            const alpha = isBorder ? 1 : 0.7;
            
            if (value >= 90) {
                return `rgba(16, 185, 129, ${alpha})`; // Green
            } else if (value >= 75) {
                return `rgba(93, 92, 222, ${alpha})`; // Primary
            } else if (value >= 50) {
                return `rgba(245, 158, 11, ${alpha})`; // Amber
            } else {
                return `rgba(239, 68, 68, ${alpha})`; // Red
            }
        }
        
        // Get gradient color for efficiency
        function getEfficiencyColorGradient(value) {
            if (value >= 90) {
                return 'rgb(16, 185, 129)'; // Green
            } else if (value >= 75) {
                return 'rgb(93, 92, 222)'; // Primary
            } else if (value >= 50) {
                return 'rgb(245, 158, 11)'; // Amber
            } else {
                return 'rgb(239, 68, 68)'; // Red
            }
        }
        
        // Update efficiency colors in the gauge chart
        function updateEfficiencyColors(chart) {
            if (!chart) return;
            
            const data = chart.data.datasets[0].data;
            chart.data.datasets[0].backgroundColor = data.map(value => getEfficiencyColor(value));
            chart.data.datasets[0].borderColor = data.map(value => getEfficiencyColor(value, true));
            chart.update();
        }
        
        // Update period chart based on selected period
        function updatePeriodChart(period) {
            if (!state.charts.hourlyPerformance) return;
            
            const chart = state.charts.hourlyPerformance;
            let labels = [];
            let deliveryData = [];
            let potentialData = [];
            
            switch (period) {
                case 'day':
                    // Show data for first 12 hours (daytime)
                    labels = state.hours.slice(0, 12).map(hour => `${hour.toString().padStart(2, '0')}:00`);
                    
                    // Calculate total delivery and potential for each hour across all fronts
                    deliveryData = state.hours.slice(0, 12).map(hour => 
                        state.fronts.reduce((sum, front) => sum + state.delivery[front][hour], 0)
                    );
                    
                    potentialData = state.hours.slice(0, 12).map(hour => 
                        hour % 2 !== 0 ? state.fronts.reduce((sum, front) => sum + state.potential[front][hour], 0) : null
                    );
                    break;
                    
                case 'week':
                    // Show data for all periods
                    labels = Object.keys(state.timePeriodsMap).map(period => 
                        `${period.substring(0, 2)}:00-${period.substring(3, 5)}:00`
                    );
                    
                    // Calculate total delivery and potential for each period across all fronts
                    deliveryData = Object.keys(state.timePeriodsMap).map(period => 
                        state.fronts.reduce((sum, front) => sum + state.twoHourDelivery[period][front], 0)
                    );
                    
                    potentialData = Object.keys(state.timePeriodsMap).map(period => 
                        state.fronts.reduce((sum, front) => sum + state.twoHourPotential[period][front], 0)
                    );
                    break;
                    
                case 'month':
                    // Show data for each front
                    labels = state.fronts.map(front => `Frente ${front}`);
                    
                    // Calculate total delivery and potential for each front across all hours
                    deliveryData = state.fronts.map(front => 
                        state.hours.reduce((sum, hour) => sum + state.delivery[front][hour], 0)
                    );
                    
                    potentialData = state.fronts.map(front => 
                        state.hours.filter(hour => hour % 2 !== 0).reduce((sum, hour) => sum + state.potential[front][hour], 0) * 2
                    );
                    break;
            }
            
            // Update chart data
            chart.data.labels = labels;
            chart.data.datasets[0].data = deliveryData;
            chart.data.datasets[1].data = potentialData;
            
            // Update chart
            chart.update();
        }
        
        // Update all charts with current data
        function updateCharts() {
            updateFrontSummaryChart();
            updateHourlyPerformanceChart();
            updateEfficiencyGaugeChart();
            updateDeliveryByPeriodChart();
            updateFrontPerformanceChart();
            updateProduction24HoursChart();
            updateTripsByFrontChart();
            updateTrucksPerHourChart();
            
            // If comparing, update comparison charts
            if (state.historyCompareMode && document.getElementById('comparison-container')?.classList.contains('block')) {
                updateComparisonCharts();
            }
        }
        
        // Update Front Summary Chart
        function updateFrontSummaryChart() {
            const chart = state.charts.frontSummary;
            if (!chart) return;
            
            const data = state.fronts.map(front => 
                state.hours.reduce((sum, hour) => sum + state.delivery[front][hour], 0)
            );
            
            chart.data.datasets[0].data = data;
            chart.update();
        }
        
        // Update Hourly Performance Chart
        function updateHourlyPerformanceChart() {
            const chart = state.charts.hourlyPerformance;
            if (!chart) return;
            
            const deliveryData = state.hours.slice(0, 12).map(hour => 
                state.fronts.reduce((sum, front) => sum + state.delivery[front][hour], 0)
            );
            
            const potentialData = state.hours.slice(0, 12).map(hour => 
                hour % 2 !== 0 ? state.fronts.reduce((sum, front) => sum + state.potential[front][hour], 0) : null
            );
            
            chart.data.datasets[0].data = deliveryData;
            chart.data.datasets[1].data = potentialData;
            chart.update();
        }
        
        // Update Efficiency Gauge Chart
        function updateEfficiencyGaugeChart() {
            const chart = state.charts.efficiencyGauge;
            if (!chart) return;
            
            const data = state.fronts.map(front => {
                const totalDelivery = state.hours.reduce((sum, hour) => sum + state.delivery[front][hour], 0);
                const totalPotential = state.hours.filter(hour => hour % 2 !== 0)
                    .reduce((sum, hour) => sum + state.potential[front][hour], 0) * 2;
                
                return totalPotential > 0 ? (totalDelivery / totalPotential) * 100 : 0;
            });
            
            chart.data.datasets[0].data = data;
            updateEfficiencyColors(chart);
        }
        
        // Update Delivery by Period Chart
        function updateDeliveryByPeriodChart() {
            const chart = state.charts.deliveryByPeriod;
            if (!chart) return;
            
            const periods = Object.keys(state.timePeriodsMap);
            const labels = periods.map(period => 
                `${period.substring(0, 2)}:00-${period.substring(3, 5)}:00`
            );
            
            const deliveryData = periods.map(period => 
                state.fronts.reduce((sum, front) => sum + state.twoHourDelivery[period][front], 0)
            );
            
            const potentialData = periods.map(period => 
                state.fronts.reduce((sum, front) => sum + state.twoHourPotential[period][front], 0)
            );
            
            chart.data.labels = labels;
            chart.data.datasets[0].data = deliveryData;
            chart.data.datasets[1].data = potentialData;
            chart.update();
        }
        
        // Update Front Performance Chart
        function updateFrontPerformanceChart() {
            const chart = state.charts.frontPerformance;
            if (!chart) return;
            
            const data = state.fronts.map(front => {
                const totalDelivery = state.hours.reduce((sum, hour) => sum + state.delivery[front][hour], 0);
                const totalPotential = state.hours.filter(hour => hour % 2 !== 0)
                    .reduce((sum, hour) => sum + state.potential[front][hour], 0) * 2;
                
                return totalPotential > 0 ? (totalDelivery / totalPotential) * 100 : 0;
            });
            
            chart.data.datasets[0].data = data;
            chart.data.datasets[0].backgroundColor = data.map(value => getEfficiencyColorGradient(value));
            chart.update();
        }
        
        // Update Production 24 Hours Chart
        function updateProduction24HoursChart() {
            const chart = state.charts.production24HoursChart;
            if (!chart) return;
            
            // Update data for each front
            state.fronts.forEach((front, index) => {
                chart.data.datasets[index].data = state.hours.map(hour => state.delivery[front][hour]);
            });
            
            chart.update();
        }
        
        // Update Trips by Front Chart
        function updateTripsByFrontChart() {
            const chart = state.charts.tripsByFront;
            if (!chart) return;
            
            const data = state.fronts.map(front => 
                state.hours.reduce((sum, hour) => sum + state.trips[front][hour], 0)
            );
            
            chart.data.datasets[0].data = data;
            chart.update();
        }
        
        // Update Trucks per Hour Chart
        function updateTrucksPerHourChart() {
            const chart = state.charts.trucksPerHour;
            if (!chart) return;
            
            // Calculate average trucks per hour for each front
            const trucksPerHourData = state.fronts.map(front => {
                const totalTrips = state.hours.reduce((sum, hour) => sum + state.trips[front][hour], 0);
                
                // Count only hours with actual trips for a more accurate average
                const hoursWithTrips = state.hours.filter(hour => state.trips[front][hour] > 0).length;
                
                // Avoid division by zero
                return hoursWithTrips > 0 ? totalTrips / hoursWithTrips : 0;
            });
            
            // Update chart data
            chart.data.datasets[0].data = trucksPerHourData;
            
            // Update chart
            chart.update();
        }
        
        // Update Dashboard Charts
        function updateDashboardCharts() {
            // Calculate total values for dashboard cards
            const totalDelivered = state.fronts.reduce((sum, front) => 
                sum + state.hours.reduce((hourSum, hour) => 
                    hourSum + state.delivery[front][hour], 0
                ), 0
            );
            
            const totalPotential = state.fronts.reduce((sum, front) => 
                sum + state.hours.filter(hour => hour % 2 !== 0).reduce((hourSum, hour) => 
                    hourSum + state.potential[front][hour], 0
                ), 0
            ) * 2;
            
            const efficiencyPercent = totalPotential > 0 ? (totalDelivered / totalPotential) * 100 : 0;
            
            const totalTrips = state.fronts.reduce((sum, front) => 
                sum + state.hours.reduce((hourSum, hour) => 
                    hourSum + state.trips[front][hour], 0
                ), 0
            );
            
            // Calculate average density across all entries with trips
            let totalDensityEntries = 0;
            let densitySum = 0;
            
            state.fronts.forEach(front => {
                state.hours.forEach(hour => {
                    if (state.trips[front][hour] > 0) {
                        densitySum += state.density[front][hour];
                        totalDensityEntries++;
                    }
                });
            });
            
            const averageDensity = totalDensityEntries > 0 ? densitySum / totalDensityEntries : 0;
            
            // Update dashboard cards
            const dashboardCards = document.querySelectorAll('.dashboard-card');
            if (dashboardCards.length >= 4) {
                // Total Delivered
                const totalDeliveredElement = dashboardCards[0].querySelector('.text-2xl');
                const totalDeliveredBar = dashboardCards[0].querySelector('.bg-primary');
                const totalDeliveredPercent = dashboardCards[0].querySelector('.text-xs');
                
                if (totalDeliveredElement) totalDeliveredElement.textContent = totalDelivered.toFixed(1);
                if (totalDeliveredBar && totalPotential > 0) {
                    const percent = Math.min((totalDelivered / totalPotential) * 100, 100);
                    totalDeliveredBar.style.width = `${percent}%`;
                }
                if (totalDeliveredPercent && totalPotential > 0) {
                    const percent = (totalDelivered / totalPotential) * 100;
                    totalDeliveredPercent.textContent = `${percent.toFixed(1)}% da meta mensal`;
                }
                
                // Efficiency
                const efficiencyElement = dashboardCards[1].querySelector('.text-2xl');
                const efficiencyBar = dashboardCards[1].querySelector('.bg-blue-500');
                
                if (efficiencyElement) efficiencyElement.textContent = `${efficiencyPercent.toFixed(1)}%`;
                if (efficiencyBar) {
                    efficiencyBar.style.width = `${Math.min(efficiencyPercent, 100)}%`;
                }
                
                // Trips
                const tripsElement = dashboardCards[2].querySelector('.text-2xl');
                const tripsBar = dashboardCards[2].querySelector('.bg-green-500');
                const tripsPercent = dashboardCards[2].querySelector('.text-xs');
                
                if (tripsElement) tripsElement.textContent = totalTrips;
                
                // Assuming a monthly target of 3000 trips (adjust as needed)
                const tripTarget = 3000;
                const tripPercentage = Math.min((totalTrips / tripTarget) * 100, 100);
                
                if (tripsBar) tripsBar.style.width = `${tripPercentage}%`;
                if (tripsPercent) tripsPercent.textContent = `${tripPercentage.toFixed(1)}% da meta mensal`;
                
                // Density
                const densityElement = dashboardCards[3].querySelector('.text-2xl');
                const densityBar = dashboardCards[3].querySelector('.bg-purple-500');
                
                if (densityElement) densityElement.textContent = averageDensity.toFixed(2);
                
                // Assuming a target density of 65 (adjust as needed)
                const densityTarget = 65;
                const densityPercentage = Math.min((averageDensity / densityTarget) * 100, 100);
                
                if (densityBar) densityBar.style.width = `${densityPercentage}%`;
            }
            
            // Update performance metrics
            const efficiencyOperationalBar = document.querySelector('.bg-primary.h-2\\.5');
            const efficiencyOperationalText = document.querySelector('.text-sm.font-medium.text-primary');
            const resourceUtilizationBar = document.querySelector('.bg-green-600.dark\\:bg-green-500');
            const resourceUtilizationText = document.querySelector('.text-sm.font-medium.text-green-600');
            const goalCompletionBar = document.querySelector('.bg-yellow-600.dark\\:bg-yellow-500');
            const goalCompletionText = document.querySelector('.text-sm.font-medium.text-yellow-600');
            const deliveryQualityBar = document.querySelector('.bg-blue-600.dark\\:bg-blue-500');
            const deliveryQualityText = document.querySelector('.text-sm.font-medium.text-blue-600');
            const totalPerformanceBar = document.querySelector('.total-percent-bar.bg-primary');
            const totalPerformanceText = document.querySelector('.text-sm.font-medium.text-primary:last-of-type');
            
            // Calculate metrics
            const operationalEfficiency = efficiencyPercent;
            const resourceUtilization = state.fronts.reduce((sum, front) => {
                const hoursWithActivity = state.hours.filter(hour => state.trips[front][hour] > 0).length;
                return sum + (hoursWithActivity / state.hours.length) * 100;
            }, 0) / state.fronts.length;
            
            const goalCompletion = totalPotential > 0 ? (totalDelivered / totalPotential) * 100 : 0;
            
            const deliveryQuality = averageDensity / 65 * 100; // Assuming target density of 65
            
            const overallPerformance = (operationalEfficiency + resourceUtilization + goalCompletion + deliveryQuality) / 4;
            
            // Update UI elements
            if (efficiencyOperationalBar) efficiencyOperationalBar.style.width = `${Math.min(operationalEfficiency, 100)}%`;
            if (efficiencyOperationalText) efficiencyOperationalText.textContent = `${operationalEfficiency.toFixed(1)}%`;
            
            if (resourceUtilizationBar) resourceUtilizationBar.style.width = `${Math.min(resourceUtilization, 100)}%`;
            if (resourceUtilizationText) resourceUtilizationText.textContent = `${resourceUtilization.toFixed(1)}%`;
            
            if (goalCompletionBar) goalCompletionBar.style.width = `${Math.min(goalCompletion, 100)}%`;
            if (goalCompletionText) goalCompletionText.textContent = `${goalCompletion.toFixed(1)}%`;
            
            if (deliveryQualityBar) deliveryQualityBar.style.width = `${Math.min(deliveryQuality, 100)}%`;
            if (deliveryQualityText) deliveryQualityText.textContent = `${deliveryQuality.toFixed(1)}%`;
            
            if (totalPerformanceBar) totalPerformanceBar.style.width = `${Math.min(overallPerformance, 100)}%`;
            if (totalPerformanceText) totalPerformanceText.textContent = `${overallPerformance.toFixed(1)}%`;
        }
        
        // Storage Functions
        function saveData() {
            try {
                const data = {
                    density: state.density,
                    trips: state.trips,
                    potential: state.potential,
                    lastUpdated: new Date().toISOString()
                };
                
                localStorage.setItem('entregaHoraData', JSON.stringify(data));
                
                // Also save to daily history if enabled
                if (state.config.autoDailySave) {
                    saveDailyHistory();
                }
                
                return true;
            } catch (error) {
                console.error('Error saving data:', error);
                showToast('Erro ao salvar dados. ' + error.message, 'error');
                return false;
            }
        }
        
        function loadSavedData() {
            try {
                const savedData = localStorage.getItem('entregaHoraData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    // Update state with saved data
                    if (data.density) state.density = data.density;
                    if (data.trips) state.trips = data.trips;
                    if (data.potential) state.potential = data.potential;
                    
                    // Recalculate delivery values
                    calculateDelivery();
                    calculateTwoHourTotals();
                    
                    // Update UI
                    updateUI();
                    
                    // Update hasData flag
                    updateHasDataFlag();
                    
                    // Show toast notification
                    const lastUpdated = data.lastUpdated ? new Date(data.lastUpdated) : new Date();
                    const timeString = lastUpdated.toLocaleTimeString();
                    showToast(`Dados carregados. Última atualização: ${timeString}`, 'info');
                    
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Erro ao carregar dados. ' + error.message, 'error');
                return false;
            }
        }
        
        // Check if there's any data entered
        function updateHasDataFlag() {
            let hasAnyData = false;
            
            // Check for density, trips, or potential values
            for (const front in state.density) {
                for (const hour in state.density[front]) {
                    if (state.density[front][hour] > 0 || state.trips[front][hour] > 0 || state.potential[front][hour] > 0) {
                        hasAnyData = true;
                        break;
                    }
                }
                if (hasAnyData) break;
            }
            
            // Update state
            state.hasData = hasAnyData;
        }
        
        // Historical data functions
        function saveDailyHistory() {
            try {
                // Get current date as YYYY-MM-DD
                const today = new Date();
                const dateKey = formatDateISO(today);
                
                // Get existing history
                let history = state.dailyHistory;
                if (!history) history = {};
                
                // Save today's data
                history[dateKey] = {
                    density: JSON.parse(JSON.stringify(state.density)),
                    trips: JSON.parse(JSON.stringify(state.trips)),
                    potential: JSON.parse(JSON.stringify(state.potential)),
                    savedAt: today.toISOString()
                };
                
                // Save back to state
                state.dailyHistory = history;
                
                // Save to localStorage
                localStorage.setItem('entregaHoraDailyHistory', JSON.stringify(history));
                
                return true;
            } catch (error) {
                console.error('Error saving daily history:', error);
                return false;
            }
        }
        
        function loadHistoricalData() {
            try {
                const savedHistory = localStorage.getItem('entregaHoraDailyHistory');
                if (savedHistory) {
                    state.dailyHistory = JSON.parse(savedHistory);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error loading historical data:', error);
                showToast('Erro ao carregar dados históricos', 'error');
                return false;
            }
        }
        
        function clearHistoricalData() {
            try {
                // Clear local state
                state.dailyHistory = {};
                
                // Clear from localStorage
                localStorage.removeItem('entregaHoraDailyHistory');
                
                // Clear selected dates
                state.selectedHistoryDates = [];
                
                // Update UI
                updateAvailableDates();
                
                // Hide comparison view
                document.getElementById('comparison-container')?.classList.add('hidden');
                
                showToast('Dados históricos limpos com sucesso', 'success');
                return true;
            } catch (error) {
                console.error('Error clearing historical data:', error);
                showToast('Erro ao limpar dados históricos', 'error');
                return false;
            }
        }
        
        function updateAvailableDates() {
            const datesContainer = document.getElementById('dates-container');
            const noHistoryMessage = document.getElementById('no-history-message');
            
            if (!datesContainer || !noHistoryMessage) return;
            
            // Clear container
            datesContainer.innerHTML = '';
            
            // Get dates from history
            const dates = Object.keys(state.dailyHistory);
            
            if (dates.length === 0) {
                // Show no history message
                noHistoryMessage.classList.remove('hidden');
                return;
            }
            
            // Hide no history message
            noHistoryMessage.classList.add('hidden');
            
            // Sort dates in descending order (newest first)
            dates.sort((a, b) => b.localeCompare(a));
            
            // Create date chips
            dates.forEach(dateStr => {
                const date = new Date(dateStr);
                const formattedDate = formatDate(date);
                
                const chip = document.createElement('div');
                chip.className = 'date-chip';
                chip.setAttribute('data-date', dateStr);
                chip.textContent = formattedDate;
                
                if (state.selectedHistoryDates.includes(dateStr)) {
                    chip.classList.add('selected');
                }
                
                chip.addEventListener('click', function() {
                    toggleDateSelection(dateStr);
                });
                
                datesContainer.appendChild(chip);
            });
        }
        
        function toggleDateSelection(dateStr) {
            const index = state.selectedHistoryDates.indexOf(dateStr);
            
            if (index === -1) {
                // If not selected yet, add it
                state.selectedHistoryDates.push(dateStr);
            } else {
                // If already selected, remove it
                state.selectedHistoryDates.splice(index, 1);
            }
            
            // Update date chips
            document.querySelectorAll('.date-chip').forEach(chip => {
                const chipDate = chip.getAttribute('data-date');
                if (state.selectedHistoryDates.includes(chipDate)) {
                    chip.classList.add('selected');
                } else {
                    chip.classList.remove('selected');
                }
            });
        }
        
        function loadDailyData(dateStr) {
            try {
                // If no history exists for this date, show error
                if (!state.dailyHistory[dateStr]) {
                    showToast(`Não há dados disponíveis para ${formatDate(new Date(dateStr))}`, 'error');
                    return false;
                }
                
                // Store current data temporarily if not in history mode
                if (!state.historyCompareMode) {
                    const currentDate = new Date();
                    const currentDateStr = formatDateISO(currentDate);
                    
                    // Save current data before loading historical data
                    saveDailyHistory();
                }
                
                // Load historical data
                const historicalData = state.dailyHistory[dateStr];
                
                // Update state data
                state.density = JSON.parse(JSON.stringify(historicalData.density));
                state.trips = JSON.parse(JSON.stringify(historicalData.trips));
                state.potential = JSON.parse(JSON.stringify(historicalData.potential));
                
                // Set selected date
                state.calendar.selectedDate = new Date(dateStr);
                
                // Set history compare mode
                state.historyCompareMode = true;
                
                // Recalculate values
                calculateDelivery();
                calculateTwoHourTotals();
                
                // Update UI
                if (state.currentPage === 'entrega-hora') {
                    generateTimePeriodHTML();
                }
                updateUI();
                
                showToast(`Visualizando dados de ${formatDate(new Date(dateStr))}`, 'info');
                return true;
            } catch (error) {
                console.error('Error loading daily data:', error);
                showToast('Erro ao carregar dados diários', 'error');
                return false;
            }
        }
        
        function exitHistoryMode() {
            // Load current data (most recently saved)
            loadSavedData();
            
            // Reset history mode flag
            state.historyCompareMode = false;
            
            // Regenerate UI if on entrega-hora page
            if (state.currentPage === 'entrega-hora') {
                generateTimePeriodHTML();
            }
            
            showToast('Saiu do modo histórico', 'info');
        }
        
        // Generate comparison view 
        function generateComparisonView() {
            const comparisonContainer = document.getElementById('comparison-container');
            const selectedDatesComparison = document.getElementById('selected-dates-comparison');
            const comparisonTableBody = document.getElementById('comparison-table-body');
            
            if (!comparisonContainer || !selectedDatesComparison || !comparisonTableBody) return;
            
            // Show comparison container
            comparisonContainer.classList.remove('hidden');
            
            // Clear containers
            selectedDatesComparison.innerHTML = '';
            comparisonTableBody.innerHTML = '';
            
            // Sort selected dates chronologically
            const sortedDates = [...state.selectedHistoryDates].sort();
            
            // Create date chips for selected dates
            sortedDates.forEach(dateStr => {
                const date = new Date(dateStr);
                const formattedDate = formatDate(date);
                
                const chip = document.createElement('div');
                chip.className = 'date-chip selected';
                chip.setAttribute('data-date', dateStr);
                chip.textContent = formattedDate;
                
                selectedDatesComparison.appendChild(chip);
            });
            
            // Add table headers
            const tableHeader = comparisonTableBody.closest('table').querySelector('thead tr');
            tableHeader.innerHTML = '<th>Métrica</th>';
            
            sortedDates.forEach(dateStr => {
                const date = new Date(dateStr);
                const formattedDate = formatDate(date);
                
                const th = document.createElement('th');
                th.textContent = formattedDate;
                tableHeader.appendChild(th);
            });
            
            // Add comparison metrics
            const metrics = [
                { name: 'Total Entregue (ton)', key: 'delivery' },
                { name: 'Total Potencial (ton)', key: 'potential' },
                { name: 'Eficiência (%)', key: 'efficiency' },
                { name: 'Viagens', key: 'trips' },
                { name: 'Densidade Média', key: 'density' }
            ];
            
            metrics.forEach(metric => {
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.textContent = metric.name;
                row.appendChild(nameCell);
                
                sortedDates.forEach(dateStr => {
                    const data = state.dailyHistory[dateStr];
                    const cell = document.createElement('td');
                    
                    let value = 0;
                    
                    switch (metric.key) {
                        case 'delivery':
                            // Calculate total delivery for the day
                            for (const front of state.fronts) {
                                for (const hour of state.hours) {
                                    value += data.density[front][hour] * data.trips[front][hour];
                                }
                            }
                            cell.textContent = value.toFixed(2);
                            break;
                            
                        case 'potential':
                            // Calculate total potential for the day
                            for (const front of state.fronts) {
                                for (const hour of state.hours) {
                                    if (hour % 2 !== 0) { // Only odd hours have potential
                                        value += data.potential[front][hour];
                                    }
                                }
                            }
                            value *= 2; // Multiply by 2 to get daily potential
                            cell.textContent = value.toFixed(2);
                            break;
                            
                        case 'efficiency':
                            // Calculate efficiency
                            let totalDelivery = 0;
                            let totalPotential = 0;
                            
                            for (const front of state.fronts) {
                                for (const hour of state.hours) {
                                    totalDelivery += data.density[front][hour] * data.trips[front][hour];
                                    
                                    if (hour % 2 !== 0) { // Only odd hours have potential
                                        totalPotential += data.potential[front][hour];
                                    }
                                }
                            }
                            
                            totalPotential *= 2; // Multiply by 2 to get daily potential
                            value = totalPotential > 0 ? (totalDelivery / totalPotential) * 100 : 0;
                            cell.textContent = value.toFixed(1) + '%';
                            
                            // Color based on efficiency
                            if (value >= 90) {
                                cell.classList.add('text-green-600', 'dark:text-green-400', 'font-semibold');
                            } else if (value >= 75) {
                                cell.classList.add('text-primary', 'font-semibold');
                            } else if (value >= 50) {
                                cell.classList.add('text-yellow-600', 'dark:text-yellow-400', 'font-semibold');
                            } else {
                                cell.classList.add('text-red-600', 'dark:text-red-400', 'font-semibold');
                            }
                            break;
                            
                        case 'trips':
                            // Calculate total trips
                            for (const front of state.fronts) {
                                for (const hour of state.hours) {
                                    value += data.trips[front][hour];
                                }
                            }
                            cell.textContent = value;
                            break;
                            
                        case 'density':
                            // Calculate average density
                            let totalDensity = 0;
                            let densityCount = 0;
                            
                            for (const front of state.fronts) {
                                for (const hour of state.hours) {
                                    if (data.trips[front][hour] > 0) {
                                        totalDensity += data.density[front][hour];
                                        densityCount++;
                                    }
                                }
                            }
                            
                            value = densityCount > 0 ? totalDensity / densityCount : 0;
                            cell.textContent = value.toFixed(2);
                            break;
                    }
                    
                    row.appendChild(cell);
                });
                
                comparisonTableBody.appendChild(row);
            });
        }
        
        // Initialize history comparison charts
        function initializeHistoryCharts() {
            // Comparison Delivery Chart
            const comparisonDeliveryCtx = document.getElementById('comparisonDeliveryChart')?.getContext('2d');
            if (comparisonDeliveryCtx) {
                state.charts.comparisonDeliveryChart = new Chart(comparisonDeliveryCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Toneladas'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.raw.toFixed(2)} ton`;
                                    }
                                }
                            },
                            legend: {
                                position: 'top'
                            },
                            datalabels: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            // Comparison Efficiency Chart
            const comparisonEfficiencyCtx = document.getElementById('comparisonEfficiencyChart')?.getContext('2d');
            if (comparisonEfficiencyCtx) {
                state.charts.comparisonEfficiencyChart = new Chart(comparisonEfficiencyCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Eficiência (%)'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Eficiência: ${context.raw.toFixed(1)}%`;
                                    }
                                }
                            },
                            legend: {
                                position: 'top'
                            },
                            datalabels: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            // Daily Trends Chart
            const dailyTrendsCtx = document.getElementById('dailyTrendsChart')?.getContext('2d');
            if (dailyTrendsCtx) {
                state.charts.dailyTrendsChart = new Chart(dailyTrendsCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Toneladas Entregues',
                                data: [],
                                borderColor: 'rgba(93, 92, 222, 1)',
                                backgroundColor: 'rgba(93, 92, 222, 0.1)',
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Eficiência (%)',
                                data: [],
                                borderColor: 'rgba(16, 185, 129, 1)',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: false,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Toneladas'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Eficiência (%)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.datasetIndex === 0) {
                                            return `Entrega: ${context.raw.toFixed(2)} ton`;
                                        } else {
                                            return `Eficiência: ${context.raw.toFixed(1)}%`;
                                        }
                                    }
                                }
                            },
                            legend: {
                                position: 'top'
                            },
                            datalabels: {
                                display: false
                            }
                        }
                    }
                });
                
                // Update daily trends chart with available data
                updateDailyTrendsChart();
            }
        }
        
        // Update comparison charts
        function updateComparisonCharts() {
            updateComparisonDeliveryChart();
            updateComparisonEfficiencyChart();
        }
        
        // Update Comparison Delivery Chart
        function updateComparisonDeliveryChart() {
            const chart = state.charts.comparisonDeliveryChart;
            if (!chart) return;
            
            // Sort selected dates chronologically
            const sortedDates = [...state.selectedHistoryDates].sort();
            
            // Format dates for display
            const labels = sortedDates.map(dateStr => formatDate(new Date(dateStr)));
            
            // Calculate delivery data for each front
            const datasets = state.fronts.map((front, index) => {
                return {
                    label: `Frente ${front}`,
                    data: sortedDates.map(dateStr => {
                        const data = state.dailyHistory[dateStr];
                        let totalDelivery = 0;
                        
                        for (const hour of state.hours) {
                            totalDelivery += data.density[front][hour] * data.trips[front][hour];
                        }
                        
                        return totalDelivery;
                    }),
                    backgroundColor: getColorForFront(index, 0.7),
                    borderColor: getColorForFront(index),
                    borderWidth: 1
                };
            });
            
            // Update chart data
            chart.data.labels = labels;
            chart.data.datasets = datasets;
            chart.update();
        }
        
        // Update Comparison Efficiency Chart
        function updateComparisonEfficiencyChart() {
            const chart = state.charts.comparisonEfficiencyChart;
            if (!chart) return;
            
            // Sort selected dates chronologically
            const sortedDates = [...state.selectedHistoryDates].sort();
            
            // Format dates for display
            const labels = sortedDates.map(dateStr => formatDate(new Date(dateStr)));
            
            // Calculate efficiency data for each front
            const datasets = state.fronts.map((front, index) => {
                return {
                    label: `Frente ${front}`,
                    data: sortedDates.map(dateStr => {
                        const data = state.dailyHistory[dateStr];
                        let totalDelivery = 0;
                        let totalPotential = 0;
                        
                        for (const hour of state.hours) {
                            totalDelivery += data.density[front][hour] * data.trips[front][hour];
                            
                            if (hour % 2 !== 0) { // Only odd hours have potential
                                totalPotential += data.potential[front][hour];
                            }
                        }
                        
                        totalPotential *= 2; // Multiply by 2 to get daily potential
                        return totalPotential > 0 ? (totalDelivery / totalPotential) * 100 : 0;
                    }),
                    backgroundColor: getColorForFront(index, 0.7),
                    borderColor: getColorForFront(index),
                    borderWidth: 1
                };
            });
            
            // Add overall efficiency dataset
            datasets.push({
                label: 'Total',
                data: sortedDates.map(dateStr => {
                    const data = state.dailyHistory[dateStr];
                    let totalDelivery = 0;
                    let totalPotential = 0;
                    
                    for (const front of state.fronts) {
                        for (const hour of state.hours) {
                            totalDelivery += data.density[front][hour] * data.trips[front][hour];
                            
                            if (hour % 2 !== 0) { // Only odd hours have potential
                                totalPotential += data.potential[front][hour];
                            }
                        }
                    }
                    
                    totalPotential *= 2; // Multiply by 2 to get daily potential
                    return totalPotential > 0 ? (totalDelivery / totalPotential) * 100 : 0;
                }),
                backgroundColor: 'rgba(0, 0, 0, 0.2)',
                borderColor: 'rgba(0, 0, 0, 0.6)',
                borderWidth: 2,
                type: 'line',
                borderDash: [5, 5]
            });
            
            // Update chart data
            chart.data.labels = labels;
            chart.data.datasets = datasets;
            chart.update();
        }
        
        // Update Daily Trends Chart
        function updateDailyTrendsChart() {
            const chart = state.charts.dailyTrendsChart;
            if (!chart) return;
            
            // Get all available dates
            const dates = Object.keys(state.dailyHistory).sort();
            
            // Format dates for display
            const labels = dates.map(dateStr => formatDate(new Date(dateStr)));
            
            // Calculate delivery and efficiency data
            const deliveryData = dates.map(dateStr => {
                const data = state.dailyHistory[dateStr];
                let totalDelivery = 0;
                
                for (const front of state.fronts) {
                    for (const hour of state.hours) {
                        totalDelivery += data.density[front][hour] * data.trips[front][hour];
                    }
                }
                
                return totalDelivery;
            });
            
            const efficiencyData = dates.map(dateStr => {
                const data = state.dailyHistory[dateStr];
                let totalDelivery = 0;
                let totalPotential = 0;
                
                for (const front of state.fronts) {
                    for (const hour of state.hours) {
                        totalDelivery += data.density[front][hour] * data.trips[front][hour];
                        
                        if (hour % 2 !== 0) { // Only odd hours have potential
                            totalPotential += data.potential[front][hour];
                        }
                    }
                }
                
                totalPotential *= 2; // Multiply by 2 to get daily potential
                return totalPotential > 0 ? (totalDelivery / totalPotential) * 100 : 0;
            });
            
            // Update chart data
            chart.data.labels = labels;
            chart.data.datasets[0].data = deliveryData;
            chart.data.datasets[1].data = efficiencyData;
            chart.update();
        }
        
        // Export Functions
        function exportJSON() {
            try {
                const data = {
                    density: state.density,
                    trips: state.trips,
                    potential: state.potential,
                    exportedAt: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                const exportFileName = `entrega-hora-export_${new Date().toISOString().slice(0, 10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileName);
                linkElement.click();
                
                showToast('Dados exportados com sucesso!', 'success');
            } catch (error) {
                console.error('Error exporting JSON:', error);
                showToast('Erro ao exportar dados. ' + error.message, 'error');
            }
        }
        
        function exportCSV() {
            try {
                // Prepare CSV data
                let csvContent = 'Frente,Hora,Densidade,Viagens,Entrega,Potencial\n';
                
                for (const front of state.fronts) {
                    for (const hour of state.hours) {
                        const density = state.density[front][hour];
                        const trips = state.trips[front][hour];
                        const delivery = state.delivery[front][hour];
                        const potential = state.potential[front][hour];
                        
                        csvContent += `${front},${hour.toString().padStart(2, '0')}:00,${density},${trips},${delivery},${potential}\n`;
                    }
                }
                
                const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);
                const exportFileName = `entrega-hora-export_${new Date().toISOString().slice(0, 10)}.csv`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileName);
                linkElement.click();
                
                showToast('Dados exportados com sucesso!', 'success');
            } catch (error) {
                console.error('Error exporting CSV:', error);
                showToast('Erro ao exportar dados. ' + error.message, 'error');
            }
        }
        
        function exportPDF() {
            try {
                // Check if jsPDF is loaded
                if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
                    console.error('jsPDF is not loaded.');
                    showToast('Erro: biblioteca jsPDF não está disponível.', 'error');
                    return;
                }
                
                const { jsPDF } = jspdf;
                
                // Create a new PDF document
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(20);
                doc.text('Relatório de Entrega por Hora', 105, 15, { align: 'center' });
                
                // Add date
                doc.setFontSize(12);
                doc.text(`Data: ${formatDate(new Date())}`, 105, 25, { align: 'center' });
                
                // Add period summaries as tables
                doc.setFontSize(14);
                doc.text('Resumo por Período', 14, 35);
                
                // Set column headers for period summary table
                const headers = [['Período', 'Frente', 'Entrega', 'Potencial', 'Diferença', 'Eficiência']];
                
                // Prepare period summary data
                const periodTableData = [];
                
                for (const period in state.timePeriodsMap) {
                    for (const front of state.fronts) {
                        const entrega = state.twoHourDelivery[period][front].toFixed(2);
                        const potencial = state.twoHourPotential[period][front];
                        const diff = state.difference[period][front].toFixed(2);
                        const eficiencia = potencial > 0 ? ((entrega / potencial) * 100).toFixed(1) + '%' : '0%';
                        
                        periodTableData.push([
                            `${period.substring(0, 2)}:00-${period.substring(3, 5)}:00`,
                            front,
                            entrega,
                            potencial.toString(),
                            diff,
                            eficiencia
                        ]);
                    }
                    
                    // Add a blank row between periods
                    periodTableData.push(['', '', '', '', '', '']);
                }
                
                // Create period summary table
                if (typeof autoTable !== 'undefined') {
                    autoTable(doc, {
                        head: headers,
                        body: periodTableData,
                        startY: 40,
                        theme: 'grid',
                        headStyles: {
                            fillColor: [93, 92, 222],
                            textColor: 255,
                            fontStyle: 'bold'
                        },
                        styles: {
                            fontSize: 10
                        }
                    });
                } else {
                    // Fallback if autoTable is not available
                    doc.text('Tabela indisponível: biblioteca autoTable não carregada.', 14, 40);
                }
                
                // Save the PDF
                const exportFileName = `entrega-hora-export_${new Date().toISOString().slice(0, 10)}.pdf`;
                doc.save(exportFileName);
                
                showToast('PDF exportado com sucesso!', 'success');
            } catch (error) {
                console.error('Error exporting PDF:', error);
                showToast('Erro ao exportar PDF. ' + error.message, 'error');
            }
        }
        
        function exportDashboard() {
            try {
                // Check if jsPDF is loaded
                if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
                    console.error('jsPDF is not loaded.');
                    showToast('Erro: biblioteca jsPDF não está disponível.', 'error');
                    return;
                }
                
                const { jsPDF } = jspdf;
                
                // Create a new PDF document
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(20);
                doc.text('Dashboard de Entrega de Safra', 105, 15, { align: 'center' });
                
                // Add date
                doc.setFontSize(12);
                doc.text(`Data: ${formatDate(new Date())}`, 105, 25, { align: 'center' });
                
                // Add summary
                doc.setFontSize(14);
                doc.text('Resumo Geral', 14, 35);
                
                // Calculate summary metrics
                const totalDelivered = state.fronts.reduce((sum, front) => 
                    sum + state.hours.reduce((hourSum, hour) => 
                        hourSum + state.delivery[front][hour], 0
                    ), 0
                );
                
                const totalPotential = state.fronts.reduce((sum, front) => 
                    sum + state.hours.filter(hour => hour % 2 !== 0).reduce((hourSum, hour) => 
                        hourSum + state.potential[front][hour], 0
                    ), 0
                ) * 2;
                
                const efficiency = totalPotential > 0 ? (totalDelivered / totalPotential) * 100 : 0;
                
                const totalTrips = state.fronts.reduce((sum, front) => 
                    sum + state.hours.reduce((hourSum, hour) => 
                        hourSum + state.trips[front][hour], 0
                    ), 0
                );
                
                // Add summary metrics
                doc.setFontSize(12);
                doc.text(`Total Entregue: ${totalDelivered.toFixed(2)} ton`, 14, 45);
                doc.text(`Eficiência: ${efficiency.toFixed(1)}%`, 14, 52);
                doc.text(`Total de Viagens: ${totalTrips}`, 14, 59);
                
                // Add front performance
                doc.setFontSize(14);
                doc.text('Desempenho por Frente', 14, 70);
                
                // Set column headers for front performance table
                const headers = [['Frente', 'Entrega (ton)', 'Potencial (ton)', 'Eficiência', 'Viagens']];
                
                // Prepare front performance data
                const frontPerformanceData = state.fronts.map(front => {
                    const totalDelivery = state.hours.reduce((sum, hour) => sum + state.delivery[front][hour], 0);
                    const totalPotential = state.hours.filter(hour => hour % 2 !== 0)
                        .reduce((sum, hour) => sum + state.potential[front][hour], 0) * 2;
                    const frontEfficiency = totalPotential > 0 ? (totalDelivery / totalPotential) * 100 : 0;
                    const frontTrips = state.hours.reduce((sum, hour) => sum + state.trips[front][hour], 0);
                    
                    return [
                        front,
                        totalDelivery.toFixed(2),
                        totalPotential.toFixed(2),
                        frontEfficiency.toFixed(1) + '%',
                        frontTrips.toString()
                    ];
                });
                
                // Create front performance table
                if (typeof autoTable !== 'undefined') {
                    autoTable(doc, {
                        head: headers,
                        body: frontPerformanceData,
                        startY: 75,
                        theme: 'grid',
                        headStyles: {
                            fillColor: [93, 92, 222],
                            textColor: 255,
                            fontStyle: 'bold'
                        },
                        styles: {
                            fontSize: 10
                        }
                    });
                } else {
                    // Fallback if autoTable is not available
                    doc.text('Tabela indisponível: biblioteca autoTable não carregada.', 14, 75);
                }
                
                // Save the PDF
                const exportFileName = `dashboard-export_${new Date().toISOString().slice(0, 10)}.pdf`;
                doc.save(exportFileName);
                
                showToast('Dashboard exportado com sucesso!', 'success');
            } catch (error) {
                console.error('Error exporting dashboard:', error);
                showToast('Erro ao exportar dashboard. ' + error.message, 'error');
            }
        }
        
        function exportAllHistory() {
            try {
                const data = state.dailyHistory;
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                const exportFileName = `historical-data-export_${new Date().toISOString().slice(0, 10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileName);
                linkElement.click();
                
                showToast('Histórico exportado com sucesso!', 'success');
            } catch (error) {
                console.error('Error exporting history:', error);
                showToast('Erro ao exportar histórico. ' + error.message, 'error');
            }
        }
        
        function importHistory(e) {
            try {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        // Validate imported data
                        if (!importedData || typeof importedData !== 'object') {
                            throw new Error('Formato de dados inválido.');
                        }
                        
                        // Confirm before importing
                        showConfirmationModal(
                            'Importar Histórico',
                            `Tem certeza que deseja importar dados históricos? Os dados existentes serão mesclados com os novos.`,
                            function() {
                                // Merge imported data with existing history
                                const updatedHistory = {...state.dailyHistory, ...importedData};
                                
                                // Update state
                                state.dailyHistory = updatedHistory;
                                
                                // Save to localStorage
                                localStorage.setItem('entregaHoraDailyHistory', JSON.stringify(updatedHistory));
                                
                                // Update UI
                                updateAvailableDates();
                                
                                showToast('Dados históricos importados com sucesso!', 'success');
                            }
                        );
                    } catch (error) {
                        console.error('Error parsing imported history:', error);
                        showToast('Erro ao analisar os dados importados. ' + error.message, 'error');
                    }
                };
                
                reader.readAsText(file);
            } catch (error) {
                console.error('Error importing history:', error);
                showToast('Erro ao importar histórico. ' + error.message, 'error');
            }
        }
        
        function exportComparison() {
            try {
                // Check if jsPDF is loaded
                if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
                    console.error('jsPDF is not loaded.');
                    showToast('Erro: biblioteca jsPDF não está disponível.', 'error');
                    return;
                }
                
                const { jsPDF } = jspdf;
                
                // Create a new PDF document
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(20);
                doc.text('Comparação de Dados Históricos', 105, 15, { align: 'center' });
                
                // Add date
                doc.setFontSize(12);
                doc.text(`Gerado em: ${formatDate(new Date())}`, 105, 25, { align: 'center' });
                
                // Sort selected dates chronologically
                const sortedDates = [...state.selectedHistoryDates].sort();
                
                // Add selected dates
                doc.setFontSize(14);
                doc.text('Datas Comparadas:', 14, 35);
                
                sortedDates.forEach((dateStr, index) => {
                    doc.setFontSize(12);
                    doc.text(formatDate(new Date(dateStr)), 14, 45 + (index * 7));
                });
                
                // Set column headers for comparison table
                const headers = [['Métrica', ...sortedDates.map(dateStr => formatDate(new Date(dateStr)))]];
                
                // Prepare comparison data
                const metrics = [
                    { name: 'Total Entregue (ton)', key: 'delivery' },
                    { name: 'Total Potencial (ton)', key: 'potential' },
                    { name: 'Eficiência (%)', key: 'efficiency' },
                    { name: 'Viagens', key: 'trips' },
                    { name: 'Densidade Média', key: 'density' }
                ];
                
                const comparisonData = metrics.map(metric => {
                    const row = [metric.name];
                    
                    sortedDates.forEach(dateStr => {
                        const data = state.dailyHistory[dateStr];
                        let value = 0;
                        
                        switch (metric.key) {
                            case 'delivery':
                                // Calculate total delivery for the day
                                for (const front of state.fronts) {
                                    for (const hour of state.hours) {
                                        value += data.density[front][hour] * data.trips[front][hour];
                                    }
                                }
                                row.push(value.toFixed(2));
                                break;
                                
                            case 'potential':
                                // Calculate total potential for the day
                                for (const front of state.fronts) {
                                    for (const hour of state.hours) {
                                        if (hour % 2 !== 0) { // Only odd hours have potential
                                            value += data.potential[front][hour];
                                        }
                                    }
                                }
                                value *= 2; // Multiply by 2 to get daily potential
                                row.push(value.toFixed(2));
                                break;
                                
                            case 'efficiency':
                                // Calculate efficiency
                                let totalDelivery = 0;
                                let totalPotential = 0;
                                
                                for (const front of state.fronts) {
                                    for (const hour of state.hours) {
                                        totalDelivery += data.density[front][hour] * data.trips[front][hour];
                                        
                                        if (hour % 2 !== 0) { // Only odd hours have potential
                                            totalPotential += data.potential[front][hour];
                                        }
                                    }
                                }
                                
                                totalPotential *= 2; // Multiply by 2 to get daily potential
                                value = totalPotential > 0 ? (totalDelivery / totalPotential) * 100 : 0;
                                row.push(value.toFixed(1) + '%');
                                break;
                                
                            case 'trips':
                                // Calculate total trips
                                for (const front of state.fronts) {
                                    for (const hour of state.hours) {
                                        value += data.trips[front][hour];
                                    }
                                }
                                row.push(value.toString());
                                break;
                                
                            case 'density':
                                // Calculate average density
                                let totalDensity = 0;
                                let densityCount = 0;
                                
                                for (const front of state.fronts) {
                                    for (const hour of state.hours) {
                                        if (data.trips[front][hour] > 0) {
                                            totalDensity += data.density[front][hour];
                                            densityCount++;
                                        }
                                    }
                                }
                                
                                value = densityCount > 0 ? totalDensity / densityCount : 0;
                                row.push(value.toFixed(2));
                                break;
                        }
                    });
                    
                    return row;
                });
                
                // Create comparison table
                let startY = 45 + (sortedDates.length * 7) + 10;
                
                if (typeof autoTable !== 'undefined') {
                    autoTable(doc, {
                        head: headers,
                        body: comparisonData,
                        startY: startY,
                        theme: 'grid',
                        headStyles: {
                            fillColor: [93, 92, 222],
                            textColor: 255,
                            fontStyle: 'bold'
                        },
                        styles: {
                            fontSize: 10
                        }
                    });
                } else {
                    // Fallback if autoTable is not available
                    doc.text('Tabela indisponível: biblioteca autoTable não carregada.', 14, startY);
                }
                
                // Save the PDF
                const exportFileName = `comparison-export_${new Date().toISOString().slice(0, 10)}.pdf`;
                doc.save(exportFileName);
                
                showToast('Comparação exportada com sucesso!', 'success');
            } catch (error) {
                console.error('Error exporting comparison:', error);
                showToast('Erro ao exportar comparação. ' + error.message, 'error');
            }
        }
        
        function createBackup() {
            try {
                const backup = {
                    entregaHoraData: JSON.parse(localStorage.getItem('entregaHoraData') || '{}'),
                    entregaHoraDailyHistory: JSON.parse(localStorage.getItem('entregaHoraDailyHistory') || '{}'),
                    entregaHoraConfig: JSON.parse(localStorage.getItem('entregaHoraConfig') || '{}'),
                    backupDate: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(backup, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                const exportFileName = `entrega-hora-backup_${new Date().toISOString().slice(0, 10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileName);
                linkElement.click();
                
                showToast('Backup criado com sucesso!', 'success');
            } catch (error) {
                console.error('Error creating backup:', error);
                showToast('Erro ao criar backup. ' + error.message, 'error');
            }
        }
        
        function restoreBackup(e) {
            try {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const backupData = JSON.parse(event.target.result);
                        
                        // Validate backup data
                        if (!backupData || typeof backupData !== 'object') {
                            throw new Error('Formato de backup inválido.');
                        }
                        
                        // Confirm before restoring
                        showConfirmationModal(
                            'Restaurar Backup',
                            `Tem certeza que deseja restaurar o backup? Todos os dados atuais serão sobrescritos.`,
                            function() {
                                // Restore data
                                if (backupData.entregaHoraData) {
                                    localStorage.setItem('entregaHoraData', JSON.stringify(backupData.entregaHoraData));
                                }
                                
                                if (backupData.entregaHoraDailyHistory) {
                                    localStorage.setItem('entregaHoraDailyHistory', JSON.stringify(backupData.entregaHoraDailyHistory));
                                    state.dailyHistory = backupData.entregaHoraDailyHistory;
                                }
                                
                                if (backupData.entregaHoraConfig) {
                                    localStorage.setItem('entregaHoraConfig', JSON.stringify(backupData.entregaHoraConfig));
                                    state.config = backupData.entregaHoraConfig;
                                    updateUIFromConfig();
                                }
                                
                                // Reload data
                                loadSavedData();
                                loadHistoricalData();
                                
                                // Update UI
                                updateAvailableDates();
                                
                                showToast('Backup restaurado com sucesso!', 'success');
                            }
                        );
                    } catch (error) {
                        console.error('Error parsing backup data:', error);
                        showToast('Erro ao analisar dados do backup. ' + error.message, 'error');
                    }
                };
                
                reader.readAsText(file);
            } catch (error) {
                console.error('Error restoring backup:', error);
                showToast('Erro ao restaurar backup. ' + error.message, 'error');
            }
        }
        
        // Report Functions
        function generateReport() {
            const reportTypeSelector = document.getElementById('report-type-selector');
            const dateSelector = document.getElementById('date-selector');
            
            if (!reportTypeSelector || !dateSelector) return;
            
            const reportType = reportTypeSelector.value;
            const dateValue = dateSelector.value;
            
            // Show loading indicator
            document.getElementById('report-loading')?.classList.remove('hidden');
            document.getElementById('no-report-data-message')?.classList.add('hidden');
            document.getElementById('report-content')?.classList.add('hidden');
            
            // Generate report based on type and date
            setTimeout(() => {
                try {
                    switch (reportType) {
                        case 'daily':
                            generateDailyReport(dateValue);
                            break;
                        case 'weekly':
                            generateWeeklyReport(dateValue);
                            break;
                        case 'monthly':
                            generateMonthlyReport(dateValue);
                            break;
                        case 'custom':
                            // Custom date range report logic
                            break;
                    }
                    
                    // Show report content
                    document.getElementById('report-content')?.classList.remove('hidden');
                    document.getElementById('report-loading')?.classList.add('hidden');
                } catch (error) {
                    console.error('Error generating report:', error);
                    showToast('Erro ao gerar relatório. ' + error.message, 'error');
                    
                    // Show no data message
                    document.getElementById('report-content')?.classList.add('hidden');
                    document.getElementById('report-loading')?.classList.add('hidden');
                    document.getElementById('no-report-data-message')?.classList.remove('hidden');
                }
            }, 500);
        }
        
        function generateDailyReport(dateStr) {
            // Parse date
            const date = new Date(dateStr);
            
            // Set report title and period
            document.getElementById('report-title').textContent = 'Relatório Diário';
            document.getElementById('report-period').textContent = `Período: ${formatDate(date)}`;
            
            // Get data for the selected date
            let data;
            
            if (isToday(date)) {
                // Use current data for today
                data = {
                    density: state.density,
                    trips: state.trips,
                    potential: state.potential
                };
            } else {
                // Get historical data
                const historyData = state.dailyHistory[dateStr];
                
                if (!historyData) {
                    throw new Error('Não há dados disponíveis para esta data.');
                }
                
                data = historyData;
            }
            
            // Calculate summary metrics
            let totalDelivered = 0;
            let totalPotential = 0;
            let totalTrips = 0;
            let densitySamples = 0;
            let densitySum = 0;
            
            // Front-specific metrics
            const frontMetrics = {};
            
            for (const front of state.fronts) {
                frontMetrics[front] = {
                    delivery: 0,
                    potential: 0,
                    trips: 0,
                    densitySamples: 0,
                    densitySum: 0
                };
                
                for (const hour of state.hours) {
                    // Calculate delivery
                    const delivery = data.density[front][hour] * data.trips[front][hour];
                    
                    frontMetrics[front].delivery += delivery;
                    totalDelivered += delivery;
                    
                    // Accumulate trips
                    frontMetrics[front].trips += data.trips[front][hour];
                    totalTrips += data.trips[front][hour];
                    
                    // Accumulate density samples
                    if (data.trips[front][hour] > 0) {
                        frontMetrics[front].densitySum += data.density[front][hour];
                        frontMetrics[front].densitySamples++;
                        
                        densitySum += data.density[front][hour];
                        densitySamples++;
                    }
                    
                    // Accumulate potential (odd hours)
                    if (hour % 2 !== 0) {
                        frontMetrics[front].potential += data.potential[front][hour];
                        totalPotential += data.potential[front][hour];
                    }
                }
                
                // Double the potential for daily total
                frontMetrics[front].potential *= 2;
            }
            
            totalPotential *= 2;
            
            // Calculate average density
            const averageDensity = densitySamples > 0 ? densitySum / densitySamples : 0;
            
            // Calculate efficiency
            const efficiency = totalPotential > 0 ? (totalDelivered / totalPotential) * 100 : 0;
            
            // Update summary cards
            document.getElementById('report-total-delivered').textContent = totalDelivered.toFixed(2);
            document.getElementById('report-efficiency').textContent = efficiency.toFixed(1) + '%';
            document.getElementById('report-trips').textContent = totalTrips;
            document.getElementById('report-density').textContent = averageDensity.toFixed(2);
            
            // Update progress bars
            document.getElementById('report-total-delivered-bar').style.width = `${Math.min((totalDelivered / totalPotential) * 100, 100)}%`;
            document.getElementById('report-total-delivered-percent').textContent = `${(totalDelivered / totalPotential * 100).toFixed(1)}% da meta`;
            
            document.getElementById('report-efficiency-bar').style.width = `${Math.min(efficiency, 100)}%`;
            document.getElementById('report-trips-bar').style.width = `${Math.min((totalTrips / 1000) * 100, 100)}%`;
            document.getElementById('report-trips-percent').textContent = `${(totalTrips / 1000 * 100).toFixed(1)}% da meta`;
            
            document.getElementById('report-density-bar').style.width = `${Math.min((averageDensity / 65) * 100, 100)}%`;
            
            // Populate the report table
            const tableBody = document.getElementById('report-table-body');
            tableBody.innerHTML = '';
            
            for (const front of state.fronts) {
                const metrics = frontMetrics[front];
                const frontEfficiency = metrics.potential > 0 ? (metrics.delivery / metrics.potential) * 100 : 0;
                const frontDensity = metrics.densitySamples > 0 ? metrics.densitySum / metrics.densitySamples : 0;
                
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">${front}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${metrics.delivery.toFixed(2)}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${metrics.potential.toFixed(2)}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${frontEfficiency.toFixed(1)}%</td>
                    <td class="px-4 py-3 whitespace-nowrap">${metrics.trips}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${frontDensity.toFixed(2)}</td>
                `;
                
                tableBody.appendChild(row);
            }
            
            // Update footer totals
            document.getElementById('report-footer-delivery').textContent = totalDelivered.toFixed(2);
            document.getElementById('report-footer-potential').textContent = totalPotential.toFixed(2);
            document.getElementById('report-footer-efficiency').textContent = efficiency.toFixed(1) + '%';
            document.getElementById('report-footer-trips').textContent = totalTrips;
            document.getElementById('report-footer-density').textContent = averageDensity.toFixed(2);
            
            // Update charts
            updateReportCharts(data);
        }
        
        function generateWeeklyReport(dateValue) {
            // Parse date range
            const [startDateStr, endDateStr] = dateValue.split('_');
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            
            // Set report title and period
            document.getElementById('report-title').textContent = 'Relatório Semanal';
            document.getElementById('report-period').textContent = `Período: ${formatDate(startDate)} a ${formatDate(endDate)}`;
            
            // Implementation for weekly report...
            // Similar to daily report but aggregating data from multiple days
        }
        
        function generateMonthlyReport(monthStr) {
            // Parse month
            const year = parseInt(monthStr.substring(0, 4));
            const month = parseInt(monthStr.substring(5, 7)) - 1;
            
            // Set report title and period
            const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            document.getElementById('report-title').textContent = 'Relatório Mensal';
            document.getElementById('report-period').textContent = `Período: ${monthNames[month]} ${year}`;
            
            // Implementation for monthly report...
            // Aggregating data from all days in the month
        }
        
        function updateReportCharts(data) {
            // Update report delivery chart
            const reportDeliveryCtx = document.getElementById('reportDeliveryChart')?.getContext('2d');
            if (reportDeliveryCtx) {
                // Destroy previous chart if exists
                if (state.charts.reportDeliveryChart) {
                    state.charts.reportDeliveryChart.destroy();
                }
                
                // Calculate total delivery for each period
                const periods = Object.keys(state.timePeriodsMap);
                const labels = periods.map(period => 
                    `${period.substring(0, 2)}:00-${period.substring(3, 5)}:00`
                );
                
                const deliveryData = periods.map(period => {
                    const hours = state.timePeriodsMap[period];
                    
                    return state.fronts.reduce((sum, front) => {
                        return sum + hours.reduce((hourSum, hour) => {
                            return hourSum + data.density[front][hour] * data.trips[front][hour];
                        }, 0);
                    }, 0);
                });
                
                // Create chart
                state.charts.reportDeliveryChart = new Chart(reportDeliveryCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Entrega por Período',
                            data: deliveryData,
                            backgroundColor: 'rgba(93, 92, 222, 0.7)',
                            borderColor: 'rgba(93, 92, 222, 1)',
                            borderWidth: 1,
                            barPercentage: 0.7,
                            categoryPercentage: 0.8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Toneladas'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Entrega: ${context.raw.toFixed(2)} ton`;
                                    }
                                }
                            },
                            legend: {
                                display: false
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => value.toFixed(1) + ' t',
                                color: function(context) {
                                    return document.documentElement.classList.contains('dark') 
                                        ? '#E5E7EB' : '#374151';
                                },
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                });
            }
            
            // Update report performance chart
            const reportPerformanceCtx = document.getElementById('reportPerformanceChart')?.getContext('2d');
            if (reportPerformanceCtx) {
                // Destroy previous chart if exists
                if (state.charts.reportPerformanceChart) {
                    state.charts.reportPerformanceChart.destroy();
                }
                
                // Calculate efficiency for each front
                const frontEfficiencyData = state.fronts.map(front => {
                    // Calculate total delivery
                    const totalDelivery = state.hours.reduce((sum, hour) => {
                        return sum + data.density[front][hour] * data.trips[front][hour];
                    }, 0);
                    
                    // Calculate total potential
                    const totalPotential = state.hours.filter(hour => hour % 2 !== 0)
                        .reduce((sum, hour) => sum + data.potential[front][hour], 0) * 2;
                    
                    // Calculate efficiency
                    return totalPotential > 0 ? (totalDelivery / totalPotential) * 100 : 0;
                });
                
                // Create chart
                state.charts.reportPerformanceChart = new Chart(reportPerformanceCtx, {
                    type: 'bar',
                    data: {
                        labels: state.fronts.map(front => `Frente ${front}`),
                        datasets: [{
                            label: 'Eficiência (%)',
                            data: frontEfficiencyData,
                            backgroundColor: frontEfficiencyData.map(value => getEfficiencyColorGradient(value)),
                            borderWidth: 0,
                            borderRadius: 4,
                            barPercentage: 0.6,
                            categoryPercentage: 0.8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Eficiência (%)'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Eficiência: ${context.raw.toFixed(1)}%`;
                                    }
                                }
                            },
                            legend: {
                                display: false
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => value.toFixed(1) + '%',
                                color: function(context) {
                                    return document.documentElement.classList.contains('dark') 
                                        ? '#E5E7EB' : '#374151';
                                },
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                });
            }
        }
        
        function exportReport() {
            try {
                // Check if jsPDF is loaded
                if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
                    console.error('jsPDF is not loaded.');
                    showToast('Erro: biblioteca jsPDF não está disponível.', 'error');
                    return;
                }
                
                const { jsPDF } = jspdf;
                
                // Create a new PDF document
                const doc = new jsPDF();
                
                // Add title
                const reportTitle = document.getElementById('report-title').textContent;
                const reportPeriod = document.getElementById('report-period').textContent;
                
                doc.setFontSize(20);
                doc.text(reportTitle, 105, 15, { align: 'center' });
                
                // Add period
                doc.setFontSize(12);
                doc.text(reportPeriod, 105, 25, { align: 'center' });
                
                // Add summary
                doc.setFontSize(14);
                doc.text('Resumo', 14, 35);
                
                // Get summary metrics
                const totalDelivered = document.getElementById('report-total-delivered').textContent;
                const efficiency = document.getElementById('report-efficiency').textContent;
                const trips = document.getElementById('report-trips').textContent;
                const density = document.getElementById('report-density').textContent;
                
                // Add summary metrics
                doc.setFontSize(12);
                doc.text(`Total Entregue: ${totalDelivered} ton`, 14, 45);
                doc.text(`Eficiência: ${efficiency}`, 14, 52);
                doc.text(`Total de Viagens: ${trips}`, 14, 59);
                doc.text(`Densidade Média: ${density}`, 14, 66);
                
                // Add front performance
                doc.setFontSize(14);
                doc.text('Detalhes por Frente', 14, 76);
                
                // Set column headers for front performance table
                const headers = [['Frente', 'Entrega (ton)', 'Potencial (ton)', 'Eficiência', 'Viagens', 'Densidade']];
                
                // Get table rows
                const tableBody = document.getElementById('report-table-body');
                const tableRows = tableBody.querySelectorAll('tr');
                
                // Prepare front performance data
                const frontPerformanceData = Array.from(tableRows).map(row => {
                    const cells = row.querySelectorAll('td');
                    return Array.from(cells).map(cell => cell.textContent);
                });
                
                // Add totals row
                const footerDelivery = document.getElementById('report-footer-delivery').textContent;
                const footerPotential = document.getElementById('report-footer-potential').textContent;
                const footerEfficiency = document.getElementById('report-footer-efficiency').textContent;
                const footerTrips = document.getElementById('report-footer-trips').textContent;
                const footerDensity = document.getElementById('report-footer-density').textContent;
                
                frontPerformanceData.push(['TOTAL', footerDelivery, footerPotential, footerEfficiency, footerTrips, footerDensity]);
                
                // Create front performance table
                if (typeof autoTable !== 'undefined') {
                    autoTable(doc, {
                        head: headers,
                        body: frontPerformanceData,
                        startY: 80,
                        theme: 'grid',
                        headStyles: {
                            fillColor: [93, 92, 222],
                            textColor: 255,
                            fontStyle: 'bold'
                        },
                        styles: {
                            fontSize: 10
                        }
                    });
                } else {
                    // Fallback if autoTable is not available
                    doc.text('Tabela indisponível: biblioteca autoTable não carregada.', 14, 80);
                }
                
                // Save the PDF
                const exportFileName = `${reportTitle.toLowerCase().replace(/\s+/g, '-')}_${new Date().toISOString().slice(0, 10)}.pdf`;
                doc.save(exportFileName);
                
                showToast('Relatório exportado com sucesso!', 'success');
            } catch (error) {
                console.error('Error exporting report:', error);
                showToast('Erro ao exportar relatório. ' + error.message, 'error');
            }
        }
        
        // Hide report content
        function hideReportContent() {
            document.getElementById('report-content')?.classList.add('hidden');
            document.getElementById('report-loading')?.classList.add('hidden');
            document.getElementById('no-report-data-message')?.classList.remove('hidden');
        }
        
        // Check if a date is today
        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                date.getMonth() === today.getMonth() &&
                date.getFullYear() === today.getFullYear();
        }
        
        // Configuration management
        function loadConfig() {
            try {
                const savedConfig = localStorage.getItem('entregaHoraConfig');
                if (savedConfig) {
                    state.config = { ...state.config, ...JSON.parse(savedConfig) };
                }
                
                // Update UI based on loaded config
                updateUIFromConfig();
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }
        
        function saveConfig() {
            try {
                localStorage.setItem('entregaHoraConfig', JSON.stringify(state.config));
                return true;
            } catch (error) {
                console.error('Error saving config:', error);
                return false;
            }
        }
        
        function updateUIFromConfig() {
            // Update auto-save toggle
            const autoSaveToggle = document.getElementById('auto-save-toggle');
            if (autoSaveToggle) autoSaveToggle.checked = state.config.autoSave;
            
            // Update auto-save interval
            const autoSaveInterval = document.getElementById('auto-save-interval');
            if (autoSaveInterval) autoSaveInterval.value = state.config.autoSaveInterval;
            
            // Update dark mode toggle
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            if (darkModeToggle) darkModeToggle.checked = state.config.darkMode;
            
            // Update alert threshold
            const alertThreshold = document.getElementById('alert-threshold');
            if (alertThreshold) alertThreshold.value = state.config.alertThreshold;
            
            // Update sound alerts toggle
            const soundAlertToggle = document.getElementById('sound-alert-toggle');
            if (soundAlertToggle) soundAlertToggle.checked = state.config.soundAlerts;
            
            // Update visual alerts toggle
            const visualAlertToggle = document.getElementById('visual-alert-toggle');
            if (visualAlertToggle) visualAlertToggle.checked = state.config.visualAlerts;
            
            // Update auto daily save toggle
            const autoDailySaveToggle = document.getElementById('auto-daily-save-toggle');
            if (autoDailySaveToggle) autoDailySaveToggle.checked = state.config.autoDailySave;
        }
        
        function updateConfigFromUI() {
            // Update auto-save toggle
            const autoSaveToggle = document.getElementById('auto-save-toggle');
            if (autoSaveToggle) state.config.autoSave = autoSaveToggle.checked;
            
            // Update auto-save interval
            const autoSaveInterval = document.getElementById('auto-save-interval');
            if (autoSaveInterval) {
                const value = parseInt(autoSaveInterval.value);
                state.config.autoSaveInterval = isNaN(value) ? 5 : Math.max(1, Math.min(60, value));
            }
            
            // Update dark mode toggle
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            if (darkModeToggle) {
                state.config.darkMode = darkModeToggle.checked;
                updateDarkMode();
            }
            
            // Update alert threshold
            const alertThreshold = document.getElementById('alert-threshold');
            if (alertThreshold) {
                const value = parseInt(alertThreshold.value);
                state.config.alertThreshold = isNaN(value) ? 10 : Math.max(1, Math.min(50, value));
            }
            
            // Update sound alerts toggle
            const soundAlertToggle = document.getElementById('sound-alert-toggle');
            if (soundAlertToggle) state.config.soundAlerts = soundAlertToggle.checked;
            
            // Update visual alerts toggle
            const visualAlertToggle = document.getElementById('visual-alert-toggle');
            if (visualAlertToggle) state.config.visualAlerts = visualAlertToggle.checked;
            
            // Update auto daily save toggle
            const autoDailySaveToggle = document.getElementById('auto-daily-save-toggle');
            if (autoDailySaveToggle) state.config.autoDailySave = autoDailySaveToggle.checked;
        }
        
        // Dark Mode Functions
        function setupDarkMode() {
            // Set initial state based on config
            updateDarkMode();
            
            // Add event listener for theme toggle button
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleDarkMode);
            }
            
            // Add event listener for system preference changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                if (!state.config.darkMode) {
                    // Only update if user hasn't manually set a preference
                    setDarkMode(e.matches);
                }
            });
        }
        
        function updateDarkMode() {
            // Check if dark mode is enabled in config
            if (state.config.darkMode) {
                setDarkMode(true);
            } else {
                // Check system preference
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                setDarkMode(prefersDark);
            }
        }
        
        function toggleDarkMode() {
            const isDark = document.documentElement.classList.contains('dark');
            setDarkMode(!isDark);
            
            // Update config
            state.config.darkMode = !isDark;
            saveConfig();
        }
        
        function setDarkMode(enable) {
            if (enable) {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-toggle-light-icon')?.classList.remove('hidden');
                document.getElementById('theme-toggle-dark-icon')?.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('theme-toggle-light-icon')?.classList.add('hidden');
                document.getElementById('theme-toggle-dark-icon')?.classList.remove('hidden');
            }
        }
        
        // Toast Notification
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;
            
            const toast = document.createElement('div');
            toast.className = 'mb-2 p-4 rounded-md shadow-md transition-all duration-300 transform translate-x-full';
            
            // Apply styles based on type
            switch (type) {
                case 'success':
                    toast.classList.add('bg-green-500', 'text-white');
                    break;
                case 'error':
                    toast.classList.add('bg-red-500', 'text-white');
                    break;
                case 'warning':
                    toast.classList.add('bg-yellow-500', 'text-white');
                    break;
                default:
                    toast.classList.add('bg-blue-500', 'text-white');
                    break;
            }
            
            toast.innerHTML = `
                <div class="flex items-center">
                    <span class="text-sm font-medium">${message}</span>
                    <button class="ml-auto focus:outline-none">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            // Add to container
            toastContainer.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
                toast.classList.add('translate-x-0');
            }, 10);
            
            // Add close button event
            toast.querySelector('button').addEventListener('click', () => {
                removeToast(toast);
            });
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                removeToast(toast);
            }, 5000);
        }
        
        function removeToast(toast) {
            // Animate out
            toast.classList.remove('translate-x-0');
            toast.classList.add('translate-x-full');
            
            // Remove from DOM after animation
            setTimeout(() => {
                toast.remove();
            }, 300);
        }
        
        // Confirmation Modal
        function showConfirmationModal(title, message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalConfirm = document.getElementById('modal-confirm');
            
            if (!modal || !modalTitle || !modalMessage || !modalConfirm) return;
            
            // Set modal content
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            // Set up confirm button
            modalConfirm.onclick = function() {
                if (typeof onConfirm === 'function') onConfirm();
                closeConfirmationModal();
            };
            
            // Show modal
            modal.classList.remove('hidden');
        }
        
        function closeConfirmationModal() {
            const modal = document.getElementById('confirmation-modal');
            if (modal) modal.classList.add('hidden');
        }
        
        // Initialize application
        function loadInitialData() {
            // Placeholder for initial data
            // This function can be expanded to load initial data from various sources
        }
    </script>
</body>
</html>
